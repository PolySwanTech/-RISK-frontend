<app-base-popup 
  [title]="'Ajouter une Nouvelle Année de Données SMA'"
  [showClose]="true"
  [actions]="popupActions"
  [dialogRef]="getDialogRef()"
  (close)="onCancel()">

  <form [formGroup]="yearForm">
    
    <!-- Section Année -->
    <div class="section">
      <div class="section-header">
        <mat-icon class="section-icon">event</mat-icon>
        <h3 class="section-title">Année de référence</h3>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Année</mat-label>
        <input matInput type="number" formControlName="newYear" 
               placeholder="Ex: 2026" min="2026" max="3000">
        <mat-icon matPrefix>calendar_today</mat-icon>
        <mat-error *ngIf="yearForm.get('newYear')?.hasError('required')">
          L'année est requise
        </mat-error>
        <mat-error *ngIf="yearForm.get('newYear')?.hasError('min')">
          L'année doit être supérieure à 2025
        </mat-error>
        <mat-error *ngIf="yearForm.get('newYear')?.hasError('max')">
          L'année doit être inférieure à 3000
        </mat-error>
      </mat-form-field>
    </div>

    <!-- Indicateur de progression -->
    <div class="progress-info" *ngIf="yearForm.get('newYear')?.valid">
      <mat-icon>analytics</mat-icon>
      <span>{{ getFilledItemsCount() }} / {{ getTotalItems() }} champs remplis</span>
    </div>

    <!-- Section Données SMA -->
    <div class="section">
      <div class="section-header">
        <mat-icon class="section-icon">account_balance</mat-icon>
        <h3 class="section-title">Données financières ({{ smaStructure.length }} catégories)</h3>
      </div>

      <mat-accordion multi="true">
        <mat-expansion-panel 
          *ngFor="let category of smaStructure; trackBy: trackByName"
          [expanded]="expandedPanels.has(category.name)"
          (opened)="expandedPanels.add(category.name)"
          (closed)="expandedPanels.delete(category.name)">
          
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-icon class="category-icon">folder</mat-icon>
              <strong>{{ category.label }}</strong>
            </mat-panel-title>
            <mat-panel-description>
              {{ category.subCategories.length }} sous-catégorie(s)
            </mat-panel-description>
          </mat-expansion-panel-header>

          <div class="category-content">
            <div class="sub-category-group" 
                 *ngFor="let subCategory of category.subCategories; trackBy: trackByName">
              
              <div class="sub-category-header">
                <mat-icon>account_tree</mat-icon>
                <h4>{{ subCategory.label }}</h4>
                <span class="item-count">{{ subCategory.items.length }} items</span>
              </div>

              <div class="items-grid">
                <mat-form-field 
                  appearance="outline" 
                  class="item-field"
                  *ngFor="let item of subCategory.items; trackBy: trackByName">
                  
                  <mat-label>{{ item.label }}</mat-label>
                  <input 
                    matInput 
                    type="number" 
                    [formControlName]="item.name" 
                    placeholder="Valeur M€"
                    min="0"
                    step="0.01">
                  <mat-icon matPrefix>euro</mat-icon>
                  
                  <mat-error *ngIf="isFieldInvalid(item.name)">
                    {{ getFieldError(item.name) }}
                  </mat-error>
                </mat-form-field>
              </div>
            </div>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </div>

    <!-- Message d'aide -->
    <div class="info-box" *ngIf="yearForm.invalid && yearForm.touched">
      <mat-icon>info</mat-icon>
      <p>Veuillez remplir tous les champs requis pour enregistrer l'année.</p>
    </div>

  </form>

</app-base-popup>