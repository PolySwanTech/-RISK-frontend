<app-go-back [title]="'Impacts Opérationnels'" [buttons]="goBackButtons" />
<br>
<br>
<br>
<br>
<br>

<div class="op-card op-mb">

  <!-- Loader -->
  <div *ngIf="isLoadingExisting" class="op-empty">
    <span class="op-empty-icon" aria-hidden="true"></span>
    <p>Chargement…</p>
  </div>

  <ng-container *ngIf="!isLoadingExisting">
    <!-- Aucun impact -->
    <div *ngIf="existingOperatingLosses.length === 0" class="op-empty">
      <span class="op-empty-icon" aria-hidden="true"></span>
      <p>Aucun impact n'est encore associé à cet incident.</p>
    </div>

    <!-- Liste -->
    <div class="op-stack" *ngIf="existingOperatingLosses.length > 0">
      <!-- Financiers -->
      <div class="op-subcard" *ngFor="let ol of existingFinancialLosses; trackBy: trackByIdString">
        <div class="op-subcard-head">
          <h3 class="op-h3">Impact Financier – {{ ol.libelle }}</h3>
          <button type="button"
                  class="btn-icon-only btn--danger"
                  (click)="deactivateOperatingLoss(ol.id)"
                  [disabled]="!ol.actif"
                  title="Désactiver">
            ✕
          </button>
        </div>

        <div class="op-grid op-grid--2">
          <div class="op-field">
            <label class="op-label">Entité</label>
            <input class="op-input" [value]="ol.entityName || '-'" disabled />
          </div>
        </div>

        <div class="op-grid op-grid--2 op-mt-xs">
          <div class="op-field">
            <label class="op-label">Crée par</label>
            <input class="op-input" [value]="ol.creatorName" disabled />
          </div>

          <div class="op-field">
            <label class="op-label">Créé le</label>
            <input class="op-input" [value]="(ol.createdAt | date:'dd/MM/yyyy')" disabled />
          </div>
        </div>

        <div class="op-field op-mt-xs">
          <label class="op-label">Description</label>
          <textarea rows="2" class="op-textarea" [value]="ol.description || '-'" disabled></textarea>
        </div>

        <div class="op-divider"></div>

        <h4 class="op-h4">Montants</h4>
        <div class="op-grid op-grid--3">
          <div class="op-field">
            <label class="op-label">Brut (€)</label>
            <input class="op-input" [value]="ol.montantBrut | number:'1.0-0'" disabled />
          </div>
          <div class="op-field">
            <label class="op-label">Net (€)</label>
            <input class="op-input" [value]="ol.montantNet | number:'1.0-0'" disabled />
          </div>
          <div class="op-field">
            <label class="op-label">Final (€)</label>
            <input class="op-input" [value]="ol.montantFinal | number:'1.0-0'" disabled />
          </div>
        </div>

       <div class="op-divider"></div>

<!-- Bouton pour expand/collapse -->
<div class="op-section-header" (click)="toggleDetails(ol.id)" style="cursor: pointer;">
  <div class="op-section-title">
    <h4 class="op-h4">Détails Comptables</h4>
  </div>
  <button type="button" class="btn btn--ghost">
    {{ expandedDetails[ol.id] ? 'Masquer' : 'Afficher' }}
  </button>
</div>

<!-- Contenu expandable -->
<div *ngIf="expandedDetails[ol.id]">
  <div *ngIf="existingAmounts[ol.id]?.length; else noAmount" class="op-stack">
    <div class="op-subcard" *ngFor="let amt of existingAmounts[ol.id]; trackBy: trackByAmountId">
      <div class="op-subcard-head">
        <h3 class="op-h3">{{ amt.amountType?.label || amt.amountType?.libelle }}</h3>
        <button type="button"
                class="btn-icon-only btn--danger"
                (click)="deactivateAmount(amt.id, ol.id)"
                [disabled]="!amt.actif"
                title="Désactiver">
          ✕
        </button>
      </div>

      <div class="op-grid op-grid--3">
        <div class="op-field">
          <label class="op-label">Date comptabilisation</label>
          <input class="op-input" [value]="amt.comptabilisationDate | date:'dd/MM/yyyy'" disabled />
        </div>
        <div class="op-field">
          <label class="op-label">Montant (€)</label>
          <input class="op-input" [value]="amt.montant | number:'1.0-0'" disabled />
        </div>
        <div class="op-field">
          <label class="op-label">Statut</label>
          <input class="op-input" [value]="getReviewStatusLabel(amt.reviewStatus) || '-'" disabled />
        </div>
      </div>

      <div class="op-grid op-grid--2 op-mt-xs">
        <div class="op-field">
          <label class="op-label">Créé le</label>
          <input class="op-input" [value]="amt.createdAt | date:'dd/MM/yyyy'" disabled />
        </div>
        <div class="op-field">
          <label class="op-label">Créé par</label>
          <input class="op-input" [value]="amt.creatorName || '-'" disabled />
        </div>
        <div class="op-field">
          <label class="op-label">Référence comptable</label>
          <input class="op-input" [value]="amt.comptabilityRef || '-'" disabled />
        </div>
      </div>
    </div>
  </div>

  <ng-template #noAmount>
    <div class="op-empty">
      <span class="op-empty-icon" aria-hidden="true"></span>
      <p>Aucun montant défini pour cet impact.</p>
    </div>
  </ng-template>
</div>


        <ng-template #noAmount>
        <div class="op-empty">
            <span class="op-empty-icon" aria-hidden="true"></span>
            <p>Aucun montant défini pour cet impact.</p>
        </div>
        </ng-template>
      </div>

      <!-- Non Financiers -->
      <div class="op-subcard" *ngFor="let ol of existingNonFinancialLosses; trackBy: trackByIdString">
        <div class="op-subcard-head">
          <h3 class="op-h3">Impact Non Financier – {{ ol.libelle }}</h3>
          <button type="button"
                  class="btn-icon-only btn--danger"
                  (click)="deactivateOperatingLoss(ol.id)"
                  [disabled]="!ol.actif"
                  title="Désactiver">
            ✕
          </button>
        </div>

        <div class="op-grid op-grid--2">
          <div class="op-field">
            <label class="op-label">Entité</label>
            <input class="op-input" [value]="ol.entityName || '-'" disabled />
          </div>
        </div>

        <div class="op-grid op-grid--2 op-mt-xs">
          <div class="op-field">
            <label class="op-label">Créé par</label>
            <input class="op-input" [value]="ol.creatorName" disabled />
          </div>

          <div class="op-field">
            <label class="op-label">Créé le</label>
            <input class="op-input" [value]="(ol.createdAt | date:'dd/MM/yyyy')" disabled />
          </div>
        </div>

        <div class="op-field op-mt-xs">
            <label class="op-label">Description</label>
            <textarea rows="2" class="op-textarea" [value]="ol.description || '-'" disabled></textarea>
        </div>

        <div class="op-divider"></div>

        <!-- Expandable détails comptables -->
        <div class="op-section-header" (click)="toggleDetails(ol.id)" style="cursor: pointer;">
            <div class="op-section-title">
            <h4 class="op-h4">Détails Comptables</h4>
            </div>
            <button type="button" class="btn btn--ghost">
            {{ expandedDetails[ol.id] ? 'Masquer' : 'Afficher' }}
            </button>
        </div>

        <div *ngIf="expandedDetails[ol.id]">
            <div *ngIf="existingAmounts[ol.id]?.length; else noAmount" class="op-stack">
            <div class="op-subcard" *ngFor="let amt of existingAmounts[ol.id]; trackBy: trackByAmountId">
                <div class="op-subcard-head">
                <h3 class="op-h3">{{ amt.amountType?.label || amt.amountType?.libelle }}</h3>
                <button type="button"
                        class="btn-icon-only btn--danger"
                        (click)="deactivateAmount(amt.id, ol.id)"
                        [disabled]="!amt.actif"
                        title="Désactiver">
                    ✕
                </button>
                </div>

                <div class="op-grid op-grid--3">
                <div class="op-field">
                    <label class="op-label">Date comptabilisation</label>
                    <input class="op-input" [value]="amt.comptabilisationDate | date:'dd/MM/yyyy'" disabled />
                </div>
                <div class="op-field">
                    <label class="op-label">Montant (€)</label>
                    <input class="op-input" [value]="amt.montant | number:'1.0-0'" disabled />
                </div>
                <div class="op-field">
                    <label class="op-label">Statut</label>
                    <input class="op-input" [value]="getReviewStatusLabel(amt.reviewStatus) || '-'" disabled />
                </div>
                </div>

                <div class="op-grid op-grid--2 op-mt-xs">
                <div class="op-field">
                    <label class="op-label">Créé le</label>
                    <input class="op-input" [value]="amt.createdAt | date:'dd/MM/yyyy'" disabled />
                </div>
                <div class="op-field">
                    <label class="op-label">Créé par</label>
                    <input class="op-input" [value]="amt.creatorName || '-'" disabled />
                </div>
                </div>
            </div>
            </div>

            <ng-template #noAmount>
            <div class="op-empty">
                <span class="op-empty-icon" aria-hidden="true"></span>
                <p>Aucun montant défini pour cet impact.</p>
            </div>
            </ng-template>
        </div>
        </div>