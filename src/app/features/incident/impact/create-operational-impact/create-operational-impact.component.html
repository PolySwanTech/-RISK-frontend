<app-base-popup 
  [title]="currentStep === 'select-type' ? 'Gérer les Impacts Opérationnels' : 
           currentStep === 'create-new' ? 'Créer un Impact ' + (isFinancial ? 'Financier' : 'Non Financier') :
           'Gérer les Impacts Existants'"
  [showClose]="true"
  [actions]="popupActions"
  [dialogRef]="getDialogRef()"
  (close)="closePopup()">

  <!-- ÉTAPE 1 : Sélection du type d'action -->
  <div class="section" *ngIf="currentStep === 'select-type'">
    <div class="action-cards">
      <div class="action-card" (click)="selectImpactType(OperatingLossFamily.FINANCIER)">
        <mat-icon class="action-icon financial">attach_money</mat-icon>
        <h3>Créer un Impact Financier</h3>
        <p>Ajouter un nouvel impact financier avec des montants comptables</p>
      </div>

      <div class="action-card" (click)="selectImpactType(OperatingLossFamily.NON_FINANCIER)">
        <mat-icon class="action-icon non-financial">warning</mat-icon>
        <h3>Créer un Impact Non Financier</h3>
        <p>Ajouter un nouvel impact non financier avec estimation</p>
      </div>

      <div class="action-card" (click)="goToManageExisting()" *ngIf="existingImpacts.length > 0">
        <mat-icon class="action-icon manage">list_alt</mat-icon>
        <h3>Gérer les Impacts Existants</h3>
        <p>Consulter, modifier ou valider les impacts existants ({{ existingImpacts.length }})</p>
      </div>
    </div>

    <div class="empty-state" *ngIf="existingImpacts.length === 0">
      <mat-icon>info</mat-icon>
      <p>Aucun impact opérationnel n'a encore été créé pour cet incident.</p>
      <p class="sub">Sélectionnez un type d'impact ci-dessus pour commencer.</p>
    </div>
  </div>

  <!-- ÉTAPE 2 : Création d'un nouvel impact -->
  <div class="section" *ngIf="currentStep === 'create-new'">
    <div class="section-header">
      <mat-icon class="section-icon">{{ isFinancial ? 'attach_money' : 'warning' }}</mat-icon>
      <h3 class="section-title">Informations de l'impact</h3>
    </div>

    <form class="forms-container">
      <div class="row-fields">
        <mat-form-field appearance="outline">
          <mat-label>Titre de l'impact</mat-label>
          <input matInput [(ngModel)]="newImpact.title" name="title" 
                 placeholder="Ex: Perte de revenus Q1" required>
          <mat-icon matPrefix>title</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Entité (Business Unit)</mat-label>
          <mat-select [(ngModel)]="newImpact.businessUnitId" name="businessUnit" required>
            <mat-option *ngFor="let bu of allBusinessUnits" [value]="bu.id">
              {{ bu.name }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>business</mat-icon>
        </mat-form-field>
      </div>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Type d'impact</mat-label>
        <mat-select [(ngModel)]="newImpact.type" name="type" required>
          <mat-option *ngFor="let type of currentImpactTypes" [value]="type">
            {{ type.label }}
          </mat-option>
        </mat-select>
        <mat-icon matPrefix>category</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Description</mat-label>
        <textarea matInput [(ngModel)]="newImpact.description" name="description" 
                  rows="3" placeholder="Décrivez l'impact en détail..."></textarea>
        <mat-icon matPrefix>description</mat-icon>
      </mat-form-field>
    </form>

    <div class="divider"></div>

    <div class="section-header">
      <mat-icon class="section-icon">calculate</mat-icon>
      <h3 class="section-title">Montants</h3>
      <button mat-icon-button class="add-btn" (click)="addAmountLine()" 
              *ngIf="isFinancial" matTooltip="Ajouter un montant">
        <mat-icon>add_circle</mat-icon>
      </button>
    </div>

    <div class="amounts-container">
      <div class="amount-row" *ngFor="let amount of newImpact.amounts; let i = index">
        <mat-form-field appearance="outline" [class.full-width]="!isFinancial">
          <mat-label>Type de montant</mat-label>
          <mat-select [(ngModel)]="amount.amountType" [name]="'amountType-' + i" required>
            <mat-option *ngFor="let type of currentAmountTypes" [value]="type.libelle">
              {{ type.label }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>label</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" *ngIf="isFinancial">
          <mat-label>Réf. comptable</mat-label>
          <input matInput [(ngModel)]="amount.accountingRef" [name]="'ref-' + i" 
                 placeholder="Ex: CMP-2025-001">
          <mat-icon matPrefix>receipt</mat-icon>
        </mat-form-field>

        <mat-form-field appearance="outline" *ngIf="isFinancial">
          <mat-label>Date comptabilisation</mat-label>
          <input matInput [matDatepicker]="picker" [(ngModel)]="amount.accountingDate" 
                 [name]="'date-' + i">
          <mat-icon matPrefix>event</mat-icon>
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Montant (€)</mat-label>
          <input matInput type="number" [(ngModel)]="amount.amount" [name]="'amount-' + i" 
                 placeholder="0.00" min="0" step="0.01" required>
          <mat-icon matPrefix>euro</mat-icon>
        </mat-form-field>

        <button mat-icon-button color="warn" (click)="removeAmountLine(i)" 
                *ngIf="isFinancial && newImpact.amounts.length > 1"
                matTooltip="Supprimer">
          <mat-icon>delete</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <!-- ÉTAPE 3 : Gestion des impacts existants -->
  <div class="section" *ngIf="currentStep === 'manage-existing'">
    <div class="section-header">
      <mat-icon class="section-icon">folder_open</mat-icon>
      <h3 class="section-title">Impacts Opérationnels ({{ existingImpacts.length }})</h3>
    </div>

    <div class="impacts-list">
      <mat-accordion multi>
        <mat-expansion-panel *ngFor="let impact of existingImpacts; trackBy: trackByImpactId"
                             [expanded]="expandedImpacts.has(impact.id)"
                             (opened)="expandedImpacts.add(impact.id)"
                             (closed)="expandedImpacts.delete(impact.id)">
          
          <mat-expansion-panel-header>
            <mat-panel-title>
              <mat-checkbox 
                [checked]="selectedImpacts.has(impact.id)"
                (click)="$event.stopPropagation()"
                (change)="toggleImpactSelection(impact.id, $event)">
              </mat-checkbox>
              <div class="impact-title">
                <mat-icon [class.financial]="impact.type.family === OperatingLossFamily.FINANCIER"
                          [class.non-financial]="impact.type.family === OperatingLossFamily.NON_FINANCIER">
                  {{ impact.type.family === OperatingLossFamily.FINANCIER ? 'attach_money' : 'warning' }}
                </mat-icon>
                <span>{{ impact.libelle }}</span>
              </div>
            </mat-panel-title>
            <mat-panel-description>
              <span class="badge" [class]="getImpactStatusColor(impact)">
                {{ impact.state | enumLabel:'operatingLossState' }}
              </span>
              <span class="meta-text">{{ impact.entityName }}</span>
            </mat-panel-description>
          </mat-expansion-panel-header>

          <!-- Contenu du panel -->
          <div class="impact-details">
            <div class="detail-grid">
              <div class="detail-field">
                <label>Type</label>
                <span>{{ impact.type.label }}</span>
              </div>
              <div class="detail-field">
                <label>Créé par</label>
                <span>{{ impact.creatorName }}</span>
              </div>
              <div class="detail-field">
                <label>Date de création</label>
                <span>{{ impact.createdAt | date:'dd/MM/yyyy' }}</span>
              </div>
            </div>

            <div class="detail-field full-width" *ngIf="impact.description">
              <label>Description</label>
              <p class="description">{{ impact.description }}</p>
            </div>

            <div class="divider"></div>

            <div class="section-header">
              <mat-icon class="section-icon">calculate</mat-icon>
              <h4 class="section-title">Montants associés</h4>
            </div>

            <div class="amounts-grid" *ngIf="impactAmounts.get(impact.id) as amounts">
              <div class="amount-card" 
                   *ngFor="let amount of amounts; trackBy: trackByAmountId"
                   [class.selected]="selectedAmounts.get(impact.id)?.has(amount.id)"
                   (click)="toggleAmountSelection(impact.id, amount.id)">
                <mat-checkbox 
                  [checked]="selectedAmounts.get(impact.id)?.has(amount.id)"
                  (click)="$event.stopPropagation()" (change)="toggleAmountSelection(impact.id, amount.id)">
                </mat-checkbox>
                <div class="amount-info">
                  <div class="amount-type">{{ amount.amountType.label }}</div>
                  <div class="amount-value">{{ amount.montant | number:'1.2-2' }} €</div>
                  <div class="amount-meta" *ngIf="amount.comptabilisationDate">
                    {{ amount.comptabilisationDate | date:'dd/MM/yyyy' }}
                  </div>
                  <span class="badge" [class]="getAmountStatusColor(amount)">
                    {{ amount.reviewStatus | enumLabel:'reviewStatus' }}
                  </span>
                </div>
              </div>

              <div class="empty-state small" *ngIf="amounts.length === 0">
                <mat-icon>info</mat-icon>
                <p>Aucun montant associé</p>
              </div>
            </div>

            <div class="divider"></div>

            <div class="action-row">
              <button mat-stroked-button color="primary" (click)="openFilesDialog(impact.id)">
                <mat-icon>attachment</mat-icon>
                Fichiers ({{ filesCounts.get(impact.id) || 0 }})
              </button>
            </div>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
    </div>

    <div class="empty-state" *ngIf="existingImpacts.length === 0">
      <mat-icon>folder_off</mat-icon>
      <p>Aucun impact opérationnel trouvé pour cet incident.</p>
    </div>
  </div>

</app-base-popup>