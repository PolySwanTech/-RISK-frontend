@if(incident){
<app-go-back [title]="`D√©tails de l'incident`" [subtitle]="incident.reference" [buttons]="goBackButtons"></app-go-back>
<div class="body-container">
    <div class="view-container">
        <div class="info-container">
            <mat-card class="incident-card">
                <mat-card-content>
                    <!-- Timeline des dates -->
                    <div class="timeline-horizontal">
                        <h3 class="timeline-title">
                            <mat-icon>schedule</mat-icon>
                            Chronologie de l'incident
                        </h3>

                        <div class="timeline-row">
                            <div class="timeline-step">
                                <div class="dot red"></div>
                                <div class="date">{{ incident.survenueAt | date: 'dd/MM/yyyy' }}</div>
                                <div class="label">
                                    <mat-icon fontIcon="place"></mat-icon> Date de survenance
                                </div>
                            </div>

                            <div class="timeline-segment">
                                <div class="days-diff">
                                    {{ getDaysDiff(incident.survenueAt, incident.detectedAt) }} jours
                                </div>

                                <div class="line-gradient" [ngStyle]="{
     'background': 'linear-gradient(to right, ' + getLineColor(incident.survenueAt, incident.detectedAt) + ', ' + getLineColor(incident.survenueAt, incident.detectedAt) + ')'
   }">
                                </div>
                            </div>

                            <div class="timeline-step">
                                <div class="dot orange"></div>
                                <div class="date">{{ incident.detectedAt | date: 'dd/MM/yyyy' }}</div>
                                <div class="label">
                                    <mat-icon fontIcon="search"></mat-icon> Date de d√©tection
                                </div>
                            </div>

                            <div class="timeline-segment">
                                <div class="days-diff">
                                    {{ getDaysDiff(incident.detectedAt, incident.declaredAt) }} jours
                                </div>

                                <div class="line-gradient" [ngStyle]="{
     'background': 'linear-gradient(to right, ' + getLineColor(incident.detectedAt, incident.declaredAt) + ', ' + getLineColor(incident.detectedAt, incident.declaredAt) + ')'
   }">
                                </div>
                            </div>

                            <div class="timeline-step">
                                <div class="dot green"></div>
                                <div class="date">{{ incident.declaredAt | date: 'dd/MM/yyyy' }}</div>
                                <div class="label">
                                    <mat-icon fontIcon="calendar_today"></mat-icon> Date de d√©claration
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informations principales en cartes -->
                    <mat-card class="general-info-card">
                        <span class="section-header">
                            <span class="pin-emoji">üìå</span>
                            <span>Informations g√©n√©rales</span>
                        </span>

                        <mat-card-content>
                            <div class="info-pairs-grid">
                                <div class="info-field">
                                    <label>Cr√©ateur</label>
                                    <div class="info-box">{{ incident.creatorName }}</div>
                                </div>
                                <div class="info-field">
                                    <label>Intervenant</label>
                                    <div class="info-box">{{ incident.intervenantName }}</div>
                                </div>
                                <div class="info-field">
                                    <label>Localisation</label>
                                    <div class="info-box">{{ incident.location ? incident.location : 'N/R' }}</div>
                                </div>

                                <div class="info-field">
                                    <label>Cause</label>
                                    <div class="info-box">{{ incident.cause ? incident.cause.name : 'N/R' }}</div>
                                </div>

                                <div class="info-field">
                                    <label>Risque</label>
                                    <div class="info-box">{{ incident.riskName ? incident.riskName : 'N/R' }}</div>
                                </div>

                                <div class="info-field">
                                    <label>Risque B√¢lois</label>
                                    <div class="info-box">{{ incident.categoryBaloise ? incident.categoryBaloise.label :
                                        'N/R' }}</div>
                                </div>

                                <div class="info-field">
                                    <label>R√©f√©rence</label>
                                    <div class="info-box">{{ incident.reference }}</div>
                                </div>

                                <div class="info-field">
                                    <label>Libell√©</label>
                                    <div class="info-box">{{ incident.title }}</div>
                                </div>

                                <div class="info-field">
                                    <label>Entit√© Responsable</label>
                                    <div class="info-box">{{ incident.teamName }}</div>
                                </div>
                            </div>
                        </mat-card-content>
                    </mat-card>


                    <!-- Description -->
                    <div class="description-section">
                        <h3 class="description-title">
                            <mat-icon>description</mat-icon>
                            Description de l'incident
                        </h3>
                        <div class="description-content">
                            <p>{{ incident.commentaire }}</p>
                        </div>
                    </div>

                    <div>
                        <h3 class="description-title">
                            <mat-icon>assessment</mat-icon>
                            Impacts de l'incident
                        </h3>
                        <mat-card>
                            <div class="table-container">
                                <table mat-table [dataSource]="impactDataSource" class="mat-elevation-z4">

                                    <ng-container *ngFor="let col of columns" [matColumnDef]="col.columnDef">
                                        <th mat-header-cell *matHeaderCellDef>
                                            {{ col.header }}
                                        </th>

                                        <td mat-cell *matCellDef="let row">
                                            <ng-container *ngIf="col.type === 'currency'; else plainCell">
                                                {{ col.cell(row) | currency:'EUR':'symbol':'1.0-2' }}
                                            </ng-container>
                                            <ng-template #plainCell>
                                                {{ col.cell(row) }}
                                            </ng-template>
                                        </td>
                                    </ng-container>

                                    <tr mat-header-row *matHeaderRowDef="displayedImpactColumns"></tr>
                                    <tr mat-row *matRowDef="let row; columns: displayedImpactColumns;"></tr>

                                    <tr class="mat-row no-data-row" *matNoDataRow>
                                        <td class="mat-cell" [attr.colspan]="displayedImpactColumns.length">
                                            <div class="no-data">
                                                <span>Aucun r√©sultat trouv√©.</span>
                                            </div>
                                        </td>
                                    </tr>

                                </table>
                            </div>
                        </mat-card>

                        @if(!isClosed()){
                        <button mat-raised-button class="btn-primary" (click)="addImpact()">
                            Voir les d√©tails
                            <mat-icon>visibility</mat-icon>
                        </button>
                        }
                    </div>
                </mat-card-content>
            </mat-card>
            <app-fichiers style="flex: 3;" [targetId]="idIncident" [closed]="isClosed()"></app-fichiers>
        </div>
    </div>

</div>

<app-audit-button [contextId]="incident.id" [contextTarget]="targetTypeEnum.INCIDENT"></app-audit-button>
}