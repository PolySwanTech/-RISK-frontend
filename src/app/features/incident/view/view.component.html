<div style="margin: 15px;">
    @if(incident){
    <app-go-back previousPageName="Liste des incidents"
        [currentPageName]="`D√©tails de l'incident - ` + incident.title"></app-go-back>
    <div class="view-container">
        <div class="info-container">
            <mat-card class="incident-card" [ngStyle]="{'height': !incident.closedAt ? '850px' : '820px'}">
                <mat-card-header>
                    <mat-card-title class="header-with-buttons">
                        <span>Info globale</span>
                        <span class="buttons-header">
                            <button mat-raised-button class="btn-primary" (click)="addActionPlan()">
                                <mat-icon>playlist_add_check</mat-icon>
                                Plan d'action
                            </button>
                            <button mat-raised-button class="btn-green" (click)="downloadExport()">
                                <mat-icon>file_download</mat-icon> Exporter
                            </button>

                            <button *ngIf="canClose && isNotClosed()" mat-raised-button class="btn-red"
                                (click)="closeIncident()">
                                <mat-icon>lock</mat-icon> Cl√¥turer
                            </button>

                        </span>
                    </mat-card-title>
                </mat-card-header>
                <mat-card-content>

                    <!-- Timeline des dates -->
                    <div class="timeline-horizontal">
                        <h3 class="timeline-title">
                            <mat-icon>schedule</mat-icon>
                            Chronologie de l'incident
                        </h3>

                        <div class="timeline-row">
                            <div class="timeline-step">
                                <div class="dot red"></div>
                                <div class="date">{{ incident.survenueAt | date: 'dd/MM/yyyy √† HH:mm' }}</div>
                                <div class="label">
                                    <mat-icon fontIcon="place"></mat-icon> Date de survenue
                                </div>
                            </div>

                            <div class="line-gradient"></div>

                            <div class="timeline-step">
                                <div class="dot orange"></div>
                                <div class="date">{{ incident.detectedAt | date: 'dd/MM/yyyy √† HH:mm' }}</div>
                                <div class="label">
                                    <mat-icon fontIcon="search"></mat-icon> Date de d√©tection
                                </div>
                            </div>

                            <div class="line-gradient"></div>

                            <div class="timeline-step">
                                <div class="dot green"></div>
                                <div class="date">{{ incident.declaredAt | date: 'dd/MM/yyyy √† HH:mm' }}</div>
                                <div class="label">
                                    <mat-icon fontIcon="calendar_today"></mat-icon> Date de d√©claration
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Informations principales en cartes -->
                    <mat-card class="general-info-card">
                        <span class="section-header">
                            <span class="pin-emoji">üìå</span>
                            <span>Informations g√©n√©rales</span>
                        </span>

                        <mat-card-content>
                            <div class="info-pairs-grid">
                                <div class="info-field">
                                    <label>Localisation</label>
                                    <div class="info-box">{{ incident.location }}</div>
                                </div>

                                <div class="info-field">
                                    <label>Cause</label>
                                    <div class="info-box">{{ incident.cause.name }}</div>
                                </div>

                                <div class="info-field">
                                    <label>Type de risque</label>
                                    <div class="info-box">{{ incident.riskName }}</div>
                                </div>

                                <div class="info-field">
                                    <label>R√©f√©rence</label>
                                    <div class="info-box">{{ incident.reference }}</div>
                                </div>

                                <div class="info-field">
                                    <label>Libell√©</label>
                                    <div class="info-box">{{ incident.title }}</div>
                                </div>
                            </div>
                        </mat-card-content>
                    </mat-card>


                    <!-- Description -->
                    <div class="description-section">
                        <h3 class="description-title">
                            <mat-icon>description</mat-icon>
                            Description de l'incident
                        </h3>
                        <div class="description-content">
                            <p>{{ incident.commentaire }}</p>
                        </div>
                    </div>
                </mat-card-content>
            </mat-card>

            <app-fichiers [incidentId]="incident.id" [incidentRef]="incident.reference" [closed]="isNotClosed()"
                style="height: 90%;"></app-fichiers>

            <mat-card class="state-card none">
                <mat-card-header>
                    <mat-card-title><span>Suivi</span>
                        <button mat-raised-button class="btn-primary" (click)="accessSuivi()">Acc√©der</button>
                    </mat-card-title>

                </mat-card-header>
                <mat-card-content>
                    <div class="comment-section">
                        <div class="comment-header-bar">
                            <span>Messages les plus r√©cents</span>
                        </div>
                        @for(s of suivi; track s.id){
                        <div class="comment-card">
                            <div class="comment-header">
                                <mat-icon class="user-icon">person</mat-icon>
                                <span class="username">
                                    {{ s.writter }} le {{ s.date | date: "d MMM y '√†' HH:mm" }}
                                </span>
                            </div>
                            <p class="comment-text">{{s.content}}</p>
                        </div>
                        }
                        <mat-form-field>
                            <mat-label>Message</mat-label>
                            <textarea matInput name="incident-com" id="commentaire" [(ngModel)]="message"></textarea>
                        </mat-form-field>
                        <button mat-raised-button class="btn-primary" (click)="sendMessage()">Envoyer</button>
                    </div>
                </mat-card-content>
            </mat-card>

        </div>
        <div class="info2-container" style="display: flex; gap: 20px;">
            <!-- Section Pi√®ces jointes -->

            <mat-card class="state-card display">
                <mat-card-header>
                    <mat-card-title><span>Suivi</span>
                        <button mat-raised-button class="btn-primary" (click)="accessSuivi()">Acc√©der</button>
                    </mat-card-title>

                </mat-card-header>
                <mat-card-content>
                    <div class="comment-section">
                        <div class="comment-header-bar">
                            <span>Messages les plus r√©cents</span>
                        </div>
                        @for(s of suivi; track s.id){
                        <div class="comment-card">
                            <div class="comment-header">
                                <mat-icon class="user-icon">person</mat-icon>
                                <span class="username">
                                    {{ s.writter }} le {{ s.date | date: "d MMM y '√†' HH:mm" }}
                                </span>
                            </div>
                            <p class="comment-text">{{s.content}}</p>
                        </div>
                        }
                        <mat-form-field>
                            <mat-label>Message</mat-label>
                            <textarea matInput name="incident-com" id="commentaire" [(ngModel)]="message"></textarea>
                        </mat-form-field>
                        <button *ngIf="isNotClosed()" mat-raised-button class="btn-primary"
                            (click)="sendMessage()">Envoyer</button>
                    </div>
                </mat-card-content>
            </mat-card>

            <mat-card class="state-card">
                <mat-card-header>
                    <mat-card-title>
                        <span>Impacts -
                            <strong>
                                Total : {{ totalAmount | currency : 'EUR' }}
                            </strong>
                        </span>
                        @if(isNotClosed()){
                        <button mat-raised-button class="btn-primary" (click)="addImpact()">
                            Ajouter
                            <mat-icon>add</mat-icon>
                        </button>
                        }
                    </mat-card-title>
                </mat-card-header>
                <mat-card-content>
                    <div class="impacts-container">
                        @for(impact of incident.impacts; track impact.id){
                        <app-impact-card [impact]="impact" [businessUnits]="businessUnits"></app-impact-card>
                        }
                    </div>
                </mat-card-content>
            </mat-card>
        </div>
    </div>
    }
</div>