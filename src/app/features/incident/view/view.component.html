<div style="margin: 15px;">
    @if(incident){
    <app-go-back previousPageName="Liste des incidents"
        [currentPageName]="`Détails de l'incident - ` + incident.reference"></app-go-back>
    <div style="text-align: right; margin-bottom: 10px;">
        <button mat-raised-button color="primary" (click)="downloadExport()">
            <mat-icon>file_download</mat-icon> Exporter
        </button>
    </div>
    <div class="info-container">
        <mat-card class="incident-card">
            <mat-card-header>
                <mat-card-title>
                    <span>Info globale</span>
                </mat-card-title>
            </mat-card-header>
            <mat-card-content>
                <div>
                    <div class="global-info">
                        <div class="info">
                            <mat-form-field class="full-width">
                                <mat-label>Location</mat-label>
                                <input matInput [value]="incident.location" readonly>
                            </mat-form-field>

                            <mat-form-field class="full-width">
                                <mat-label>Type de risque</mat-label>
                                <input matInput [value]="incident.risk.balois" readonly>
                            </mat-form-field>

                            <!-- <mat-form-field class="full-width">
                                <mat-label>Sous Catégorie de risque</mat-label>
                                <input matInput [value]="incident.subRisk.balois" readonly>
                            </mat-form-field> -->
                        </div>
                        <div class="dates">
                            <mat-form-field class="full-width">
                                <mat-label>Date de déclaration</mat-label>
                                <input matInput [value]="formatDate(incident.declaredAt)" readonly>
                            </mat-form-field>

                            <mat-form-field class="full-width">
                                <mat-label>Date de survenance</mat-label>
                                <input matInput [value]="formatDate(incident.survenueAt)" readonly>
                            </mat-form-field>

                            <mat-form-field class="full-width">
                                <mat-label>Date de détection</mat-label>
                                <input matInput [value]="formatDate(incident.detectedAt)" readonly>
                            </mat-form-field>
                            @if(incident.closedAt){
                            <mat-form-field class="full-width">
                                <mat-label>Date de clôture</mat-label>
                                <input matInput [value]="formatDate(incident.closedAt)" readonly>
                            </mat-form-field>
                            }
                        </div>
                    </div>
                    <mat-form-field>
                        <mat-label>Description de l'incident</mat-label>
                        <textarea matInput name="incident-com" id="commentaire" [(ngModel)]="incident.comments"
                            readonly></textarea>
                    </mat-form-field>
                </div>
            </mat-card-content>
        </mat-card>
        <mat-card class="state-card">
            <mat-card-header>
                <mat-card-title><span>Suivi</span> </mat-card-title>
                <button mat-raised-button class="btn-primary" (click)="accessSuivi()">Accéder</button>
            </mat-card-header>
            <mat-card-content>

                <div class="comment-section">
                    <div class="comment-header-bar">
                      <span>Messages les plus récents</span>
                    </div>
                    @for(s of suivi; track s.id){
                    <div class="comment-card">
                        <div class="comment-header">
                            <mat-icon class="user-icon">person</mat-icon>
                            <span class="username">
                                {{ s.writter }} le {{ s.date | date: "d MMM y 'à' HH:mm" }}
                              </span>
                        </div>
                        <p class="comment-text">{{s.content}}</p>
                    </div>
                    }
                    <mat-form-field>
                        <mat-label>Message</mat-label>
                        <textarea matInput name="incident-com" id="commentaire" [(ngModel)]="message"></textarea>
                    </mat-form-field>
                    <button mat-raised-button class="btn-primary" (click)="sendMessage()">Envoyer</button>
                </div>
            </mat-card-content>
        </mat-card>
    </div>
    <mat-card class="state-card">
        <mat-card-header>
            <mat-card-title>
                <span>Impacts -
                    <strong>
                        Total : {{ totalAmount | currency : 'EUR' }}
                    </strong>
                </span>
                @if(isNotClosed()){
                <button mat-raised-button class="btn-primary" (click)="addImpact()">
                    Ajouter
                    <mat-icon>add</mat-icon>
                </button>
                }
            </mat-card-title>
        </mat-card-header>
        <mat-card-content>
            <div class="impacts-container">
                @for(impact of incident.impacts; track impact){
                <app-impact-card [impact]="impact"></app-impact-card>
                }
            </div>
        </mat-card-content>
    </mat-card>
    }
</div>