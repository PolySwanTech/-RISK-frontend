<mat-horizontal-stepper style="margin-top: 20px;" [linear]="true" #stepper>
  <!-- Étape 1 : Sélection -->
  <mat-step>
    <ng-template matStepLabel>Sélection</ng-template>
    <app-bu-process-accordion (riskSelected)="onRiskChange($event)"></app-bu-process-accordion>
    <mat-chip-listbox style="margin-bottom: 20px;" *ngIf="selectedBPR">
      <mat-chip> Unité métier : {{ selectedBPR.bu.name }}</mat-chip>
      <mat-chip> Processus : {{ selectedBPR.process.name }}</mat-chip>
      <mat-chip>Risque : {{ selectedBPR.risk.name }}</mat-chip>
    </mat-chip-listbox>
    <!-- <h2>Sélection de l'Unité Métier</h2>
    <div class="business-units">
      <div *ngFor="let bu of hierarchicalProcesses" class="business-unit" [class.active]="selectedBU?.name === bu.name"
        (click)="selectBusinessUnit(bu)">
        {{ bu.name }}
      </div>
    </div>

    <div *ngIf="selectedBU">
      <h2>Sélection du Processus</h2>

      <div *ngIf="!selectedBU.children?.length" class="empty-message">
        <mat-card class="empty-card">
          <mat-card-content>
            <p>Aucun processus disponible pour cette unité métier.</p>
          </mat-card-content>
        </mat-card>
      </div>

      <div *ngIf="selectedBU.children?.length" class="processes">
        <div *ngFor="let p of selectedBU.children" class="process-container">
          <div class="process-card" [class.selected]="selectedProcess?.id === p.id" (click)="selectProcess(p)">
            <span class="chip-name">{{ p.name }}</span>
          </div>
          <div *ngIf="p.children?.length" class="subprocess-container">
            <div *ngFor="let child of p.children" class="process-card child"
              [class.selected]="selectedProcess?.id === child.id" (click)="selectProcess(child)">
              <span class="chip-name">{{ child.name }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="selectedProcess" class="selection-panel">
      <h2>Sélection du Risque</h2>

      <div *ngIf="!risks?.length" class="empty-message">
        <mat-card class="empty-card">
          <mat-card-content>
            <p>Aucun risque disponible pour ce processus.</p>
          </mat-card-content>
        </mat-card>
      </div>

      <div *ngIf="risks?.length">
        <mat-form-field appearance="fill" class="full-width">
          <mat-label>Type de risque</mat-label>
          <mat-select [(ngModel)]="selectedRisk" (selectionChange)="onRiskChange()">
            <mat-option [value]="null">Sélectionnez un type de risque</mat-option>
            <mat-option *ngFor="let risk of risks" [value]="risk">
              {{ risk.libellePerso }}
            </mat-option>
          </mat-select>
        </mat-form-field>
      </div>
    </div> -->

    <div style="margin-top: 20px;">
      <button mat-raised-button class="btn-primary" (click)="stepper.next()"
        [disabled]="!selectedProcess || !selectedRisk">Suivant</button>
    </div>
  </mat-step>

  <!-- Étape 2 : Évaluation -->
  <mat-step [editable]="false">
    <ng-template matStepLabel>Évaluation Brut</ng-template>

    <h2>⚖️ Évaluation Brut Des Impacts</h2>
    <h3>Financier Direct</h3>
    <div class="impacts-grid">
      <mat-card *ngFor="let sev of severityList; let i = index" class="impact-card" (click)="financialImpact = sev.id">
        <mat-card-header [ngClass]="getClassByIndex(i)">
          <mat-card-title>{{ sev.libelle }}</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Fréquence</mat-label>
            <mat-select [(ngModel)]="sev.selectedFrequency" (selectionChange)="updateRisk(sev)">
              <mat-option *ngFor="let freq of frequencyList" [value]="freq">{{ freq.libelle }}</mat-option>
            </mat-select>
          </mat-form-field>
          <div class="risk-result" *ngIf="sev.riskLevel">
            <mat-chip [ngClass]="sev.riskLevel.name.toLowerCase()">
              {{ getRiskLevelEnum(sev.riskLevel.name) }}
            </mat-chip>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <div class="form-group" style="flex-direction: row; gap: 20px; margin-top: 20px;">
      <mat-form-field appearance="fill">
        <mat-label>Financier Indirect</mat-label>
        <mat-select [(ngModel)]="financierIndirect" (selectionChange)="updateHighestRisk()">
          <mat-option *ngFor="let risk of riskLevels" [value]="risk">{{ getRiskLevelEnum(risk) }}</mat-option>
        </mat-select>
      </mat-form-field>
      <mat-form-field appearance="fill">
        <mat-label>Non Financier</mat-label>
        <mat-select [(ngModel)]="financierNonFinancier" (selectionChange)="updateHighestRisk()">
          <mat-option *ngFor="let risk of riskLevels" [value]="risk">{{ getRiskLevelEnum(risk) }}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <div class="summary">
      <h3>Résumé de l'Évaluation</h3>
      <p><strong>Unité Métier:</strong> {{ selectedBU?.name }}</p>
      <p><strong>Processus:</strong> {{ selectedProcess?.name }}</p>
      <p><strong>Risque:</strong> {{ selectedRisk?.libellePerso }}</p>
      <mat-form-field appearance="fill">
        <mat-label>Niveau de Risque proposé</mat-label>
        <mat-select [(ngModel)]="highestRiskLevel">
          <mat-option *ngFor="let risk of riskLevels" [value]="risk">{{ getRiskLevelEnum(risk) }}</mat-option>
        </mat-select>
        <div *ngIf="highestRiskLevel">
          <div style="width: 100%; height: 20px; border: 1px solid black;"
            [style.backgroundColor]="getRiskColorEnum(highestRiskLevel)">
          </div>
        </div>
      </mat-form-field>
    </div>

     @if(matrixData) {
          <app-matrix [matrixData]="matrixData" [modifPlan]="false"></app-matrix>
        }

    <div style="display: flex; gap: 20px;">
      <button mat-raised-button class="btn-red" (click)="stepper.previous()">Retour</button>
      <button mat-raised-button class="btn-primary" (click)="gotoSteppe3(stepper)"
        [disabled]="!highestRiskLevel">Suivant</button>
    </div>
  </mat-step>

  <mat-step [editable]="false">
    <ng-template matStepLabel>Évaluation Net</ng-template>

    <h2>⚖️ Évaluation Net Des Impacts</h2>

    <div class="form-group" style="flex-direction: column; gap: 20px; align-items: flex-start; margin-top: 20px;">
      <div class="controls-grid">
        <mat-card *ngFor="let ctrl of controls" class="control-card"
          [ngStyle]="{'border-left': '5px solid ' + ctrl.riskLevel.color}">
          <mat-card-header style="justify-content: start;">
            <mat-card-title>{{ ctrl.libelle }}</mat-card-title>
            <mat-card-subtitle>{{ getControlTypeLabels(ctrl.controlType) }} - {{ getDegreeLabels(ctrl.controlLevel)
              }}</mat-card-subtitle>
          </mat-card-header>

          <mat-card-content>
            <p><strong>Processus:</strong> {{ ctrl.processName }}</p>
            <p><strong>Fréquence:</strong> {{ getRecLabel(ctrl.frequency) }}</p>
            <p><strong>Prochain Exécution:</strong> {{ ctrl.nextExecution | date:'dd/MM/yyyy' }}</p>
            <p><strong>Créateur:</strong> {{ ctrl.creator }}</p>
            <mat-chip
              [ngStyle]="{'background-color': ctrl.riskLevel.color, 'color': getContrastColor(ctrl.riskLevel.color)}">
              {{ ctrl.riskLevel.name }}
            </mat-chip>
          </mat-card-content>
        </mat-card>
      </div>
      <mat-form-field *ngIf="highestRiskLevelNet" appearance="fill">
        <mat-label>Niveau de Risque proposé</mat-label>
        <mat-select [(ngModel)]="highestRiskLevelNet">
          <mat-option *ngFor="let risk of riskLevels" [value]="risk">{{ getRiskLevelEnum(risk) }}</mat-option>
        </mat-select>
        <div *ngIf="highestRiskLevelNet">
          <div style="width: 100%; height: 20px; border: 1px solid black;"
            [style.backgroundColor]="getRiskColorEnum(highestRiskLevelNet)">
          </div>
        </div>
      </mat-form-field>
    </div>
    <div style="display: flex; gap: 20px;">
      <button mat-raised-button class="btn-red" (click)="stepper.previous()">Retour</button>
      <button mat-raised-button class="btn-primary" (click)="saveEvaluation(stepper)"
        [disabled]="!highestRiskLevelNet">Terminer l'évaluation</button>
    </div>
  </mat-step>

  <!-- Étape 3 : Résultats -->
  <mat-step [editable]="false">
    <ng-template matStepLabel>Résultats</ng-template>
    <h2>Évaluation Enregistrée</h2>
    <div class="success-message">
      <p>L'évaluation du risque a été enregistrée avec succès.</p>
      <button mat-raised-button class="btn-primary" (click)="newEvaluation(); stepper.reset()">Nouvelle
        évaluation</button>
    </div>
  </mat-step>
</mat-horizontal-stepper>