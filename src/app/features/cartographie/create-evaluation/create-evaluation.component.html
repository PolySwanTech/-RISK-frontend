<app-go-back [title]="'Cr√©ation d\'une cartographie'"></app-go-back>
<mat-card>
  <mat-horizontal-stepper [linear]="true" #stepper>
    <!-- √âtape 1 : S√©lection -->
    <mat-step>
      <ng-template matStepLabel>S√©lection</ng-template>
      <app-bu-process-accordion *ngIf="!selectedRisk"></app-bu-process-accordion>
      <mat-chip-listbox style="margin-bottom: 20px;" *ngIf="selectedRisk">
        <mat-chip> Unit√© m√©tier : {{ selectedBU?.name || "N/R" }}</mat-chip>
        <mat-chip> Processus : {{ selectedProcess?.name || "N/R" }}</mat-chip>
        <mat-chip>Risque : {{ selectedRisk.libelle }}</mat-chip>
      </mat-chip-listbox>

      <div style="margin-top: 20px;">
        <button mat-raised-button class="btn-primary" (click)="stepper.next()"
          [disabled]="!selectedRisk">Suivant</button>
      </div>
    </mat-step>

    <!-- √âtape 2 : √âvaluation Brute -->
    <mat-step [editable]="false">
      <ng-template matStepLabel>√âvaluation Brute</ng-template>

      <h2>‚öñÔ∏è √âvaluation Brut Des Impacts</h2>
      <h3>Financier Direct</h3>
      <div class="impacts-grid">
        <mat-card *ngFor="let sev of severityList; let i = index" class="impact-card">
          <mat-card-header [ngClass]="getClassByIndex(i)">
            <mat-card-title>{{ sev.libelle }}</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Fr√©quence</mat-label>
              <mat-select [ngModel]="getSeverityValue(sev.id)" (ngModelChange)="setSeverityValue(sev.id, $event)"
                (selectionChange)="updateRisk(sev)">
                <mat-option *ngFor="let freq of frequencyList" [value]="freq.id">
                  {{ freq.libelle }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <div class="risk-result" *ngIf="getSeverityValue(sev.id) != 0">
              <mat-chip [ngClass]="getRiskLevelFromSeverityFrequencySelected(sev).toLowerCase()">
                {{ getRiskLevelFromSeverityFrequencySelected(sev) | enumLabel:'riskLevel' }}
              </mat-chip>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <div class="form-group" style="flex-direction: row; gap: 20px; margin-top: 20px;">
        <mat-form-field appearance="fill">
          <mat-label>Financier Indirect</mat-label>
          <mat-select [(ngModel)]="financierIndirect" (selectionChange)="updateHighestRisk()">
            <mat-option *ngFor="let risk of riskLevels" [value]="risk">{{ risk | enumLabel:'riskLevel' }}</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="fill">
          <mat-label>Non Financier</mat-label>
          <mat-select [(ngModel)]="financierNonFinancier" (selectionChange)="updateHighestRisk()">
            <mat-option *ngFor="let risk of riskLevels" [value]="risk">{{ risk | enumLabel:'riskLevel' }}</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="summary">
        <h3>R√©sum√© de l'√âvaluation</h3>
        <p><strong>Unit√© M√©tier:</strong> {{ selectedBU?.name || "N/R" }}</p>
        <p><strong>Processus:</strong> {{ selectedProcess?.name || "N/R" }}</p>
        <p><strong>Risque:</strong> {{ selectedRisk?.libelle }}</p>
        <mat-form-field appearance="fill">
          <mat-label>Niveau de Risque propos√©</mat-label>
          <mat-select [(ngModel)]="highestRiskLevel">
            <mat-option *ngFor="let risk of riskLevels" [value]="risk">{{ risk | enumLabel:'riskLevel' }}</mat-option>
          </mat-select>
          <div *ngIf="highestRiskLevel">
            <div style="width: 100%; height: 20px; border: 1px solid black;"
              [style.backgroundColor]="getRiskColorEnum(highestRiskLevel)">
            </div>
          </div>
        </mat-form-field>
      </div>

      @if(matrixData) {
      <app-matrix [matrixData]="matrixData" [modifPlan]="false"></app-matrix>
      }

      <div style="display: flex; gap: 20px;">
        <button mat-raised-button class="btn-red" (click)="stepper.previous()">Retour</button>
        <button mat-raised-button class="btn-primary" (click)="gotoSteppe3(stepper)"
          [disabled]="!highestRiskLevel">Suivant</button>
      </div>
    </mat-step>

    <!-- √âtape 3 : √âvaluation Nette-->
    <mat-step [editable]="false">
      <ng-template matStepLabel>√âvaluation Nette</ng-template>

      <h2>‚öñÔ∏è √âvaluation Net Des Impacts</h2>

      <div class="form-group" style="flex-direction: column; gap: 20px; align-items: flex-start; margin-top: 20px;">
        <div class="controls-grid">
          <mat-card *ngFor="let ctrl of controls" class="control-card"
            [ngStyle]="{'border-left': '5px solid ' + ctrl.riskLevel.color}">
            <mat-card-header style="justify-content: start;">
              <mat-card-title>{{ ctrl.libelle }}</mat-card-title>
              <mat-card-subtitle>{{ ctrl.controlType | enumLabel:'controlType' }} - {{ ctrl.controlLevel | enumLabel:'degree' }}</mat-card-subtitle>
            </mat-card-header>

            <mat-card-content>
              <p><strong>Processus:</strong> {{ ctrl.processName }}</p>
              <p><strong>Fr√©quence:</strong> {{ ctrl.frequency | enumLabel:'recurrence' }}</p>
              <p><strong>Prochain Ex√©cution:</strong> {{ ctrl.nextExecution | date:'dd/MM/yyyy' }}</p>
              <p><strong>Cr√©ateur:</strong> {{ ctrl.creator }}</p>
              <mat-chip
                [ngStyle]="{'background-color': ctrl.riskLevel.color, 'color': getContrastColor(ctrl.riskLevel.color)}">
                {{ ctrl.riskLevel.name }}
              </mat-chip>
            </mat-card-content>
          </mat-card>
        </div>

        <h3>üõ°Ô∏è Mesures d'att√©nuation</h3>

        <div class="attenuation-grid" *ngIf="attenuationMetrics.length > 0; else noMetrics">
          <mat-card *ngFor="let metric of attenuationMetrics" class="attenuation-card">
            <mat-card-header>
              <mat-card-title>{{ metric.libelle }}</mat-card-title>
              <mat-card-subtitle>{{ metric.type.label || 'Type inconnu' }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <p>{{ metric.description || 'Aucune description.' }}</p>
              <p><strong>Cr√©√©e par :</strong> {{ metric.creatorName }}</p>
              <p><strong>Date de cr√©ation :</strong> {{ metric.createdAt | date:'dd/MM/yyyy' }}</p>
              <p><strong>Evaluation :</strong> {{ (metric.evaluation | enumLabel:'evaluation') || 'Aucune √©valuation' }}</p>
              <mat-chip [color]="metric.actif ? 'primary' : 'warn'">
                {{ metric.actif ? 'Active' : 'Inactif' }}
              </mat-chip>
            </mat-card-content>
          </mat-card>
        </div>

        <ng-template #noMetrics>
          <p>Aucune mesure d'att√©nuation n'est associ√©e √† ce risque.</p>
        </ng-template>


        <mat-form-field *ngIf="highestRiskLevelNet" appearance="fill">
          <mat-label>Niveau de Risque propos√©</mat-label>
          <mat-select [(ngModel)]="highestRiskLevelNet">
            <mat-option *ngFor="let risk of riskLevels" [value]="risk">{{ risk | enumLabel:'riskLevel' }}</mat-option>
          </mat-select>
          <div *ngIf="highestRiskLevelNet">
            <div style="width: 100%; height: 20px; border: 1px solid black;"
              [style.backgroundColor]="getRiskColorEnum(highestRiskLevelNet)">
            </div>
          </div>
        </mat-form-field>
      </div>
      <div style="display: flex; gap: 20px;">
        <button mat-raised-button class="btn-red" (click)="stepper.previous()">Retour</button>
        <button mat-raised-button class="btn-primary" (click)="saveEvaluation(stepper)"
          [disabled]="!highestRiskLevelNet">Terminer l'√©valuation</button>
      </div>
    </mat-step>

    <!-- √âtape 3 : R√©sultats -->
    <mat-step [editable]="false">
      <ng-template matStepLabel>R√©sultats</ng-template>
      <h2>√âvaluation Enregistr√©e</h2>
      <div class="success-message">
        <p>L'√©valuation du risque a √©t√© enregistr√©e avec succ√®s.</p>
        <button mat-raised-button class="btn-primary" (click)="newEvaluation(); stepper.reset()">Nouvelle
          √©valuation</button>
      </div>
    </mat-step>
  </mat-horizontal-stepper>
</mat-card>