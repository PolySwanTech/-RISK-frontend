<app-base-popup
  [title]="pageTitle"
  [showClose]="true"
  [actions]="popupActions"
  [dialogRef]="getDialogRef()"
  (close)="closePopup()">
  
  <form [formGroup]="form" (ngSubmit)="onSubmit()">
    <!-- Section Informations générales -->
    <div class="section">
      <div class="section-header">
        <mat-icon class="section-icon">info</mat-icon>
        <h3 class="section-title">Informations générales</h3>
      </div>
      <div class="forms-container">
        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Titre du risque</mat-label>
          <input matInput formControlName="libellePerso" placeholder="Ex: Perte de données client">
          <mat-icon matPrefix>title</mat-icon>
          <mat-error *ngIf="form.get('libellePerso')?.hasError('required')">
            Le titre est obligatoire
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full-width">
          <mat-label>Description</mat-label>
          <textarea matInput formControlName="description" rows="3"
                    placeholder="Décrivez l'événement redouté..."></textarea>
          <mat-icon matPrefix>description</mat-icon>
        </mat-form-field>
      </div>
    </div>

    <!-- Section Association Risque -->
    <div class="section">
      <div class="section-header">
        <mat-icon class="section-icon">category</mat-icon>
        <h3 class="section-title">Risque de référence</h3>
        <div class="section-header-actions">
          <button mat-raised-button type="button" class="btn-purple" (click)="openRiskEventDialog()">
            <mat-icon>add</mat-icon>
            Associer
          </button>
        </div>
      </div>
      <div class="association-content">
        <mat-chip-listbox *ngIf="risk" class="chip-list">
          <mat-chip class="custom-chip">
            <div>
              <mat-icon>category</mat-icon>
              Taxonomie : {{ risk.riskReferentiel.libelle }}
            </div>
          </mat-chip>
        </mat-chip-listbox>
        <div class="empty-state" *ngIf="!risk">
          <mat-icon>link_off</mat-icon>
          <p>Aucun risque de référence. Cliquez sur "Associer" pour en sélectionner un.</p>
        </div>
      </div>
    </div>

    <!-- Section Processus -->
    <div class="section" *ngIf="listProcess.length > 0">
      <div class="section-header">
        <mat-icon class="section-icon">account_tree</mat-icon>
        <h3 class="section-title">Processus associé</h3>
      </div>
      <div class="forms-container">
        <app-select-arborescence
          tooltip="Sélectionnez le processus associé"
          [id]="form.get('processId')!.value"
          (changeValue)="onProcessSelected($event)"
          placeholder="Sélectionnez un processus"
          [list]="listProcess">
        </app-select-arborescence>
      </div>
    </div>
  </form>
</app-base-popup>