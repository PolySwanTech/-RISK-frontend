<app-go-back [title]="'Mesures d\'atténuations'" [buttons]="goBackButtons"></app-go-back>

<div class="attenuation-container">
  <!-- Section des catégories -->
  <div class="categories-section">
    <div class="categories-grid">
      <mat-card
        *ngFor="let group of groupedCategories; trackBy: trackByCode"
        [class.selected]="selectedCategories().includes(group.parent.code)"
        (click)="toggleCategory(group.parent.code)"
        class="category-card">
        
        <div class="card-content">
          <div class="card-header">
            <div class="icon-wrapper">
              <mat-icon>{{ getParentIcon(group.parent.code) }}</mat-icon>
            </div>
            <div class="card-title">
              <h3>{{ group.parent.label }}</h3>
              <div class="count-badge">{{ getCountForParent(group.parent.code) }}</div>
            </div>
          </div>

          <div class="subcategories" *ngIf="group.children.length > 0">
            <div class="subcategory"
                *ngFor="let c of group.children"
                [class.empty]="c.count === 0">
              <span class="subcategory-label">
                <mat-icon class="sub-icon">subdirectory_arrow_right</mat-icon>
                {{ c.type.label }}
              </span>
              <span class="subcategory-count">{{ c.count }}</span>
            </div>
          </div>
        </div>

        <div class="card-overlay" *ngIf="selectedCategories().includes(group.parent.code)">
          <mat-icon>check_circle</mat-icon>
        </div>
      </mat-card>
    </div>
  </div>

  <!-- Section du tableau avec en-tête -->
  <div class="table-section">
    <!-- En-tête de la liste -->
    <div class="section-header">
      <div class="header-content">
        <div class="header-left">
          <mat-icon class="header-icon">assessment</mat-icon>
          <div class="header-title-group">
            <h2 class="section-title">Liste des mesures d'atténuation</h2>
            <p class="section-subtitle">Gestion et suivi des mesures de conformité</p>
          </div>
        </div>
        <div class="header-actions">
          <!-- Barre de recherche -->
          <mat-form-field class="search-field" appearance="outline">
            <mat-icon matPrefix>search</mat-icon>
            <input 
              matInput 
              placeholder="Rechercher ..." 
              [(ngModel)]="searchText"
              (ngModelChange)="applySearchAndFilter()">
            <button mat-icon-button matSuffix *ngIf="searchText" (click)="clearSearch()">
              <mat-icon>close</mat-icon>
            </button>
          </mat-form-field>
          
          <div class="header-stats">
            <div class="stat-card" *ngIf="selectedCategories().length > 0">
              <mat-icon>filter_list</mat-icon>
              <div class="stat-content">
                <span class="stat-value">{{ selectedCategories().length }}</span>
                <span class="stat-label">Filtre(s)</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Conteneur de la liste -->
    <div class="table-container mat-elevation-z2">
      <mat-accordion class="metrics-accordion">
        <mat-expansion-panel *ngFor="let m of paginatedMetrics" class="metric-panel" hideToggle>
          <mat-expansion-panel-header>
            <mat-panel-title class="panel-title-grid">
              <!-- Référence -->
              <div class="grid-cell reference-cell">
                <span class="cell-label">Référence</span>
                <span class="cell-value">{{ m.reference }}</span>
              </div>

              <!-- Libellé -->
              <div class="grid-cell libelle-cell">
                <span class="cell-label">Libellé</span>
                <span class="cell-value">{{ m.libelle || 'Sans libellé' }}</span>
              </div>

              <!-- Type -->
              <div class="grid-cell type-cell">
                <span class="cell-label">Type</span>
                <span class="cell-value">
                  <span class="type-badge">
                    <mat-icon>label</mat-icon>
                    {{ m.type.label || 'Non catégorisé' }}
                  </span>
                </span>
              </div>

              <!-- Évaluation -->
              <div class="grid-cell evaluation-cell">
                <span class="cell-label">Évaluation</span>
                <span class="cell-value">
                  <div class="evaluation-badge-compact" 
                       [attr.data-status]="m.evaluation || 'NONE'">
                    <mat-icon class="status-icon">
                      {{
                        m.evaluation === 'CONFORME' ? 'check_circle' :
                        m.evaluation === 'PARTIELLEMENT_CONFORME' ? 'error' :
                        m.evaluation === 'NON_CONFORME' ? 'cancel' : 
                        m.evaluation === 'NON_APPLICABLE' ? 'remove_circle_outline' : 'help_outline'
                      }}
                    </mat-icon>
                    <span>{{ m.evaluation ? getEvaluationLabel(m.evaluation) : 'Non évaluée' }}</span>
                  </div>
                </span>
              </div>

              <!-- État -->
              <div class="grid-cell status-cell">
                <span class="cell-label">État</span>
                <span class="cell-value">
                  <span class="status-badge" [class.active]="m.actif">
                    <mat-icon>{{ m.actif ? 'check_circle' : 'cancel' }}</mat-icon>
                    {{ m.actif ? 'Active' : 'Inactive' }}
                  </span>
                </span>
              </div>
            </mat-panel-title>
          </mat-expansion-panel-header>

          <div class="panel-body">
            <!-- Description -->
            <div class="info-block description-block">
              <div class="block-header">
                <mat-icon>subject</mat-icon>
                <span class="block-title">Description</span>
              </div>
              <div class="block-content">
                {{ m.description || 'Aucune description disponible.' }}
              </div>
            </div>

            <!-- Informations secondaires -->
            <div class="info-grid">
              <!-- Évaluer la mesure -->
              <div class="info-block evaluation-select-block">
                <div class="block-header">
                  <mat-icon>rate_review</mat-icon>
                  <span class="block-title">Évaluer la mesure</span>
                </div>
                <div class="block-content">
                  <mat-form-field appearance="outline" class="evaluation-select">
                    <mat-label>Statut de conformité</mat-label>
                    <mat-select 
                      [value]="m.evaluation"
                      (selectionChange)="onEvaluationSelect(m, $event.value)">
                      <mat-option [value]="null">
                        <mat-icon>help_outline</mat-icon>
                        Non évaluée
                      </mat-option>
                      <mat-option *ngFor="let key of evaluationKeys" [value]="key">
                        <mat-icon>
                          {{
                            key === 'CONFORME' ? 'check_circle' :
                            key === 'PARTIELLEMENT_CONFORME' ? 'error' :
                            key === 'NON_CONFORME' ? 'cancel' : 'remove_circle_outline'
                          }}
                        </mat-icon>
                        {{ getEvaluationLabel(key) }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>

              <!-- Informations de création -->
              <div class="info-block metadata-block">
                <div class="block-header">
                  <mat-icon>info_outline</mat-icon>
                  <span class="block-title">Informations</span>
                </div>
                <div class="block-content">
                  <div class="metadata-row">
                    <mat-icon>account_circle</mat-icon>
                    <span class="metadata-label">Créé par :</span>
                    <span class="metadata-value">{{ m.creatorName || 'Inconnu' }}</span>
                  </div>
                  <div class="metadata-row">
                    <mat-icon>calendar_today</mat-icon>
                    <span class="metadata-label">Date :</span>
                    <span class="metadata-value">{{ m.createdAt | date:'dd/MM/yyyy' }}</span>
                  </div>
                </div>
              </div>

              <!-- Pièces jointes -->
              <div class="info-block attachments-block">
                <div class="block-header">
                  <mat-icon>attach_file</mat-icon>
                  <span class="block-title">Documents joints</span>
                </div>
                <div class="block-content">
                  <button 
                    mat-stroked-button 
                    color="primary" 
                    class="attachment-btn"
                    (click)="openFilesDialog(m.id)">
                    <mat-icon>cloud_upload</mat-icon>
                    Gérer les fichiers
                  </button>
                </div>
              </div>

              <!-- État de la mesure -->
              <div class="info-block status-block">
                <div class="block-header">
                  <mat-icon>power_settings_new</mat-icon>
                  <span class="block-title">État de la mesure</span>
                </div>
                <div class="block-content">
                  <div class="toggle-wrapper">
                    <mat-slide-toggle
                      color="primary"
                      [checked]="m.actif"
                      (change)="toggleActivation(m, $event.checked)">
                      <span class="toggle-label">{{ m.actif ? 'Active' : 'Inactive' }}</span>
                    </mat-slide-toggle>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </mat-expansion-panel>
      </mat-accordion>

      <!-- État vide -->
      <div class="empty-state" *ngIf="paginatedMetrics.length === 0">
        <div class="empty-icon">
          <mat-icon>{{ searchText || selectedCategories().length > 0 ? 'search_off' : 'folder_open' }}</mat-icon>
        </div>
        <h3 class="empty-title">Aucune mesure d'atténuation trouvée</h3>
        <p class="empty-description">
          {{ searchText 
            ? 'Aucune mesure ne correspond à votre recherche "' + searchText + '". Essayez avec d\'autres mots-clés.'
            : selectedCategories().length > 0 
              ? 'Aucune mesure ne correspond aux filtres sélectionnés. Essayez de modifier vos critères de recherche.'
              : 'Commencez par créer votre première mesure pour assurer la conformité de vos processus.' }}
        </p>
        <div class="empty-actions">
          <button mat-raised-button color="primary" (click)="openCreateDialog()" *ngIf="!searchText && selectedCategories().length === 0">
            <mat-icon>add</mat-icon>
            Créer une mesure
          </button>
          <button mat-stroked-button color="primary" (click)="clearSearch()" *ngIf="searchText">
            <mat-icon>clear</mat-icon>
            Effacer la recherche
          </button>
          <button mat-stroked-button color="primary" (click)="resetFilters()" *ngIf="selectedCategories().length > 0 && !searchText">
            <mat-icon>clear</mat-icon>
            Réinitialiser les filtres
          </button>
        </div>
      </div>

      <!-- Pagination -->
      <mat-paginator 
        *ngIf="filteredMetrics.length > 0"
        [length]="filteredMetrics.length"
        [pageSize]="pageSize"
        [pageSizeOptions]="[5, 10, 25, 50]"
        [pageIndex]="pageIndex"
        (page)="onPageChange($event)"
        showFirstLastButtons
        class="metrics-paginator">
      </mat-paginator>
    </div>
  </div>
</div>