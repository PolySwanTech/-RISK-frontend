<app-go-back [title]="cartoMode ? 'Cartographie' : 'Gestion des processus'" [buttons]="goBackButtons"></app-go-back>

<div class="container">
  
  <div class="content">
    <!-- Arbre des processus -->
    <div class="tree-section">
      <h2>Structure des Processus</h2>
      <div class="tree">

        <!-- Racines : Business Units -->
        <div *ngFor="let bu of businessUnits" class="tree-node">

          <!-- Élément BU -->
          <div class="process-item node-bu" [class.selected]="selectedBu?.id === bu.id"
              (click)="selectBu(bu)">
            <span class="toggle" (click)="toggleExpand(bu, $event)">
              {{ (bu.children.length > 0 || bu.process.length > 0) ? (bu.expanded ? '▼' : '▶') : '•' }}
            </span>
            
            <span class="process-name">{{ bu.name }}</span>
            <span class="badge badge-bu">BU</span>
          </div>

          <!-- Enfants de la BU -->
          <div *ngIf="bu.expanded" class="children">
            <!-- Processus de la BU -->
            <ng-container *ngTemplateOutlet="processTree; context: {$implicit: getRootProcesses(bu)}"></ng-container>

            <!-- Sous-BU -->
            <ng-container *ngTemplateOutlet="buTree; context: {$implicit: bu.children}"></ng-container>
          </div>
        </div>
      </div>
    </div>

    <!-- Template des processus -->
    <ng-template #processTree let-enfants>
      <div *ngFor="let child of enfants" class="tree-node">
        <div class="process-item child" [class.selected]="selectedProcess?.id === child.id" (click)="selectProcess(child)">
          <span class="toggle" (click)="toggleExpand(child, $event)">
            {{ child.enfants.length > 0 ? (child.expanded ? '▼' : '▶') : '•' }}
          </span>
          <span class="process-name">{{ child.name }}</span>
          <span class="badge" [class]="'badge-' + child.niveau">{{ getLevelLabel(child.niveau) }}</span>
          <span class="risk-count" *ngIf="child.risks && child.risks.length > 0">
            {{ child.risks.length }} risque(s)
          </span>
        </div>
        <div *ngIf="child.expanded" class="enfants">
          <ng-container *ngTemplateOutlet="processTree; context: {$implicit: child.enfants}"></ng-container>
        </div>
      </div>
    </ng-template>

    <!-- Template récursif pour les sous-BU -->
    <ng-template #buTree let-children>
      <div *ngFor="let bu of children" class="tree-node">
        <div class="process-item node-bu child" [class.selected]="selectedBu?.id === bu.id"
            (click)="selectBu(bu)">
          <span class="toggle" (click)="toggleExpand(bu, $event)">
            {{ (bu.children.length > 0 || bu.process.length > 0) ? (bu.expanded ? '▼' : '▶') : '•' }}
          </span>
          <span class="process-name">{{ bu.name }}</span>
          <span class="badge badge-bu">BU</span>
        </div>

        <div *ngIf="bu.expanded" class="children">
          <ng-container *ngTemplateOutlet="processTree; context: {$implicit: bu.process}"></ng-container>
          <ng-container *ngTemplateOutlet="buTree; context: {$implicit: bu.children}"></ng-container>
        </div>
      </div>
    </ng-template>


    <!-- Détails et actions -->
    <div class="details-section">
      <!-- Périodes disponibles -->
      <div *ngIf="cartoMode && selectedBu && periods.length > 0" class="periods-container">
        <h3>Périodes disponibles</h3>
        <div class="chips">
          <span
            *ngFor="let period of periods"
            class="chip"
            [class.selected]="period === selectedPeriod"
            (click)="selectedPeriod = period">
            {{ period }}
          </span>
        </div>
      </div>
      <div *ngIf="!selectedBu && !selectedProcess" class="placeholder">
        <p>Sélectionnez une Business Unit ou un Processus pour voir les détails</p>
      </div>

      <!-- Détails BU sélectionnée -->
      <div *ngIf="selectedBu && !selectedProcess" class="process-details">
        <h2>{{ selectedBu.name }}</h2>
        <p class="level-info">Unité métier</p>
        <div class="actions">
          <button class="btn btn-primary" (click)="addProcess()">
            + Ajouter un processus
          </button>
        </div>

        <div class="risk-events-section">
          <h3>Événements de risque redouté ({{ viewedRisks.length }})</h3>
          <div *ngIf="viewedRisks.length > 0; else noRisk">
            <mat-card>
              <div class="table-container">
                <table mat-table [dataSource]="riskDataSource" matSort class="mat-elevation-z8 modern-table">
                  
                  <ng-container matColumnDef="libelle">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Libellé</th>
                    <td mat-cell *matCellDef="let risk" (click)="onRiskRowClick(risk, $event)">
                      <strong>{{ risk.libelle }}</strong>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="description">
                    <th mat-header-cell *matHeaderCellDef mat-sort-header>Description</th>
                    <td mat-cell *matCellDef="let risk" (click)="onRiskRowClick(risk, $event)">
                      {{ risk.description }}
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="riskBrut">
                    <th mat-header-cell *matHeaderCellDef>Évaluation Brute</th>
                    <td mat-cell *matCellDef="let risk" (click)="onRiskRowClick(risk, $event)">
                      <mat-chip 
                        class="evaluation-chip"
                        [ngStyle]="{'background-color': getRiskBrutColor(risk), 'color': '#fff'}">
                        {{ getRiskBrutEvaluation(risk) === 'NON_EVALUATED' ? 'Non évalué' : getRiskBrutEvaluation(risk) }}
                      </mat-chip>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="riskNet">
                    <th mat-header-cell *matHeaderCellDef>Évaluation Nette</th>
                    <td mat-cell *matCellDef="let risk" (click)="onRiskRowClick(risk, $event)">
                      <mat-chip 
                        class="evaluation-chip"
                        [ngStyle]="{'background-color': getRiskNetColor(risk), 'color': '#fff'}">
                        {{ getRiskNetEvaluation(risk) === 'NON_EVALUATED' ? 'Non évalué' : getRiskNetEvaluation(risk) }}
                      </mat-chip>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="action" *ngIf="cartoMode">
                    <th mat-header-cell *matHeaderCellDef>Action</th>
                    <td mat-cell *matCellDef="let risk" class="action-cell">
                      <button mat-raised-button 
                              class="btn btn-secondary" 
                              (click)="chooseRiskForCarto(risk); $event.stopPropagation()">
                        Sélectionner
                        <mat-icon>arrow_forward</mat-icon>
                      </button>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="riskDisplayedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: riskDisplayedColumns;" 
                      matTooltip="Cliquez pour gérer les évaluations" 
                      class="clickable-row">
                  </tr>

                  <tr class="mat-row no-data-row" *matNoDataRow>
                    <td class="mat-cell" [attr.colspan]="riskDisplayedColumns.length">
                      <div class="no-data">
                        <span>Aucun résultat trouvé.</span>
                      </div>
                    </td>
                  </tr>

                </table>
                <mat-paginator [length]="riskDataSource.data.length" 
                               [pageSizeOptions]="[5, 10, 15]"
                               aria-label="Page selection pour le tableau des risques" 
                               showFirstLastButtons>
                </mat-paginator>
              </div>
            </mat-card>
          </div>
          <ng-template #noRisk>
            <p class="empty-state">Aucun risque identifié pour cette BU</p>
          </ng-template>
        </div>
      </div>

      <div *ngIf="selectedProcess && !showDispatchModal" class="process-details">
        <h2>{{ selectedProcess.name }}</h2>
        <p class="level-info">Niveau : {{ getLevelLabel(selectedProcess.niveau) }}</p>

        <div class="actions">
          <button *ngIf="selectedProcess && selectedProcess.niveau && selectedProcess.niveau < 3"
            class="btn btn-primary" (click)="initiateAddChild()">
            + Ajouter un sous-processus
          </button>
        </div>

        <div class="risk-events-section">
          <h3 *ngIf="selectedProcess">Événements de risque redouté ({{ viewedRisks ? viewedRisks.length : 0 }})</h3>
          <button *ngIf="selectedProcess && selectedProcess.enfants.length == 0" mat-raised-button
            style="margin-bottom : 10px;" class="btn btn-primary" (click)="createNewEvent()">+ Ajouter évènement
            redouté</button>
          <div *ngIf="viewedRisks.length > 0; else noRisk" class="risk-list">
            <div *ngFor="let risk of viewedRisks" class="risk-item" (click)="onRiskRowClick(risk, $event)">
              <div class="risk-label">
                <strong>{{ risk.libelle }}</strong>
                <p>{{ risk.description }}</p>
                <div class="evaluations">
                  <mat-chip 
                    class="evaluation-chip"
                    [ngStyle]="{'background-color': getRiskBrutColor(risk), 'color': '#fff'}">
                    Brute: {{ getRiskBrutEvaluation(risk) === 'NON_EVALUATED' ? 'Non évalué' : getRiskBrutEvaluation(risk) }}
                  </mat-chip>
                  <mat-chip 
                    class="evaluation-chip"
                    [ngStyle]="{'background-color': getRiskNetColor(risk), 'color': '#fff'}">
                    Nette: {{ getRiskNetEvaluation(risk) === 'NON_EVALUATED' ? 'Non évalué' : getRiskNetEvaluation(risk) }}
                  </mat-chip>
                </div>
              </div>
              <div class="risk-selection">
                <button *ngIf="cartoMode" mat-raised-button class="btn btn-secondary" (click)="chooseRiskForCarto(risk); $event.stopPropagation()">
                  Sélectionner
                  <mat-icon>arrow_forward</mat-icon>
                </button>
              </div>
            </div>
          </div>
          <ng-template #noRisk>
            <p class="empty-state">Aucun événement de risque associé</p>
          </ng-template>
        </div>
      </div>
      <div *ngIf="showDispatchModal" class="dispatch-modal">
        <h2>Dispatcher les événements de risque redouté</h2>
        <p *ngIf="selectedProcess && selectedProcess.risks && selectedProcess.risks.length > 0" class="warning">
          ⚠️ Le processus "{{ selectedProcess.name }}" possède {{ selectedProcess.risks.length }} événement(s)
          de risque.
          Vous devez créer au moins 2 sous-processus et dispatcher les risques redoutés entre eux.
        </p>

        <div class="subprocess-creation">
          <h3>Création des sous-processus</h3>
          <div *ngFor="let sp of newSubprocesses; let i = index" class="subprocess-form">
            <div class="form-row">
              <label>Sous-processus {{ i + 1 }}</label>
              <input type="text" [(ngModel)]="sp.name" placeholder="Nom du sous-processus" class="form-control">
              <button *ngIf="newSubprocesses.length > 2" class="btn-icon btn-danger" (click)="removeSubprocess(i)">
                ✕
              </button>
            </div>
          </div>
          <button class="btn btn-secondary" (click)="addSubprocess()">
            + Ajouter un autre sous-processus
          </button>
        </div>

        <div class="risk-dispatch" *ngIf="selectedProcess && selectedProcess.risks && selectedProcess.risks.length > 0">
          <h3>Dispatcher les risques</h3>
          <div *ngFor="let risk of selectedProcess?.risks" class="risk-dispatch-item">
            <div class="risk-info">
              <strong>{{ risk.libelle }}</strong>
              <p>{{ risk.description }}</p>
            </div>
            <select [(ngModel)]="riskDispatch[risk.id]" class="form-control" [class.invalid]="!riskDispatch[risk.id]">
              <option *ngFor="let sp of newSubprocesses; let i = index" [value]="i">
                {{ sp.name || 'Sous-processus ' + (i + 1) }}
              </option>
            </select>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-secondary" (click)="cancelDispatch()">
            Annuler
          </button>
          <button class="btn btn-primary" [disabled]="!canConfirmDispatch()" (click)="confirmDispatch()">
            Confirmer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>