<div class="wrapper">

  <!-- ====== TOGGLE MODE NAVIGATION ====== -->
  <div class="navigation-mode-toggle">
    <mat-button-toggle-group 
      [value]="navigationMode" 
      (change)="onNavigationModeChange($event.value)">
      <mat-button-toggle [value]="NavigationMode.Hierarchical">
        <mat-icon>account_tree</mat-icon>
        Navigation hiérarchique
      </mat-button-toggle>
      <mat-button-toggle [value]="NavigationMode.Direct">
        <mat-icon>filter_list</mat-icon>
        Accès direct
      </mat-button-toggle>
    </mat-button-toggle-group>
  </div>

  <!-- ====== FILTRES MODE DIRECT ====== -->
  <div *ngIf="navigationMode === NavigationMode.Direct && !showSearchResults" class="filters-section">
    <mat-form-field appearance="outline" class="filter-field">
      <mat-label>Catégorie Baloise Niveau 1</mat-label>
      <mat-select [(value)]="selectedCategoryLevel1" (selectionChange)="onCategoryLevel1Change()">
        <mat-option [value]="null">Toutes les catégories</mat-option>
        <mat-option *ngFor="let cat of categoriesLevel1" [value]="cat.libelle">
          {{ format(cat.libelle) }}
        </mat-option>
      </mat-select>
      <mat-icon matPrefix>folder</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" class="filter-field" *ngIf="selectedCategoryLevel1">
      <mat-label>Catégorie Baloise Niveau 2</mat-label>
      <mat-select [(value)]="selectedCategoryLevel2" (selectionChange)="onCategoryLevel2Change()">
        <mat-option [value]="null">Toutes les sous-catégories</mat-option>
        <mat-option *ngFor="let cat of categoriesLevel2" [value]="cat.libelle">
          {{ format(cat.libelle) }}
        </mat-option>
      </mat-select>
      <mat-icon matPrefix>subdirectory_arrow_right</mat-icon>
    </mat-form-field>
  </div>

  <!-- ====== BARRE DE RECHERCHE ====== -->
  <div class="search-section">
    <div class="search-input-wrapper">
      <mat-icon class="search-icon">search</mat-icon>

      <input
        type="text"
        class="search-input"
        [placeholder]="searchPlaceholder"
        [(ngModel)]="searchQuery"
        (input)="onSearchInput($event)"
      />

      <button *ngIf="searchQuery" mat-icon-button (click)="clearSearch()" class="search-clear-btn">
        <mat-icon>clear</mat-icon>
      </button>
    </div>

    <!-- Résultats de recherche -->
    <div *ngIf="showSearchResults" class="search-results">
      <!-- Loading -->
      <div *ngIf="isSearching" class="search-loading">
        <mat-spinner diameter="24"></mat-spinner>
        <div class="search-loading-text">Recherche en cours...</div>
      </div>

      <!-- Aucun résultat -->
      <div *ngIf="!isSearching && searchResults.length === 0" class="search-empty">
        Aucun {{ searchTypeLabel.toLowerCase() }} trouvé pour
        "<strong>{{ searchQuery }}</strong>"
        <button *ngIf="isDialog" mat-flat-button color="primary" (click)="createNewEvent()">
          <mat-icon>add</mat-icon> Créer un nouvel événement
        </button>
      </div>

      <!-- Liste des résultats -->
      <div *ngFor="let result of searchResults" class="search-result-item" (click)="selectSearchResult(result)">
        <div class="search-result-header">
          <strong class="search-result-name">{{ format(result.libelle) }}</strong>
          <span class="search-result-type type-risque">{{ searchTypeLabel }}</span>
        </div>
        <div class="search-result-path" *ngIf="result.description">{{ result.description }}</div>
      </div>
    </div>
  </div>

  <!-- ====== NAVIGATION HIÉRARCHIQUE ====== -->
  <div *ngIf="!showSearchResults" class="list-panel">
    <!-- En-tête -->
    <div class="panel-title">
      <div class="panel-title-left">
        <button *ngIf="canGoBack" mat-icon-button (click)="back()">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <h2>{{ viewTitle }}</h2>
      </div>

      <div class="breadcrumb" *ngIf="navigationMode === NavigationMode.Hierarchical">
        <span *ngFor="let step of breadcrumb; let last = last">
          {{ step }} <span *ngIf="!last">›</span>
        </span>
      </div>

      <div class="results-count" *ngIf="navigationMode === NavigationMode.Direct && currentLevel === 'referentiels'">
        {{ currentItems.length }} taxonomie(s)
      </div>
    </div>

    <!-- Contenu -->
    <div *ngIf="isLoading" class="empty">
      <mat-spinner></mat-spinner>
      <p>Chargement...</p>
    </div>

    <mat-list *ngIf="!isLoading">

      <!-- NIVEAU 1 : Catégories (mode hiérarchique uniquement) -->
      <ng-container *ngIf="currentLevel === 'categories' && navigationMode === NavigationMode.Hierarchical">
        <mat-list-item *ngFor="let cat of currentItems" (click)="selectCategory(cat)">
          <mat-icon matListIcon>folder</mat-icon>
          <h3 matLine>{{ format(cat.libelle) }}</h3>
          <mat-icon matSuffix>chevron_right</mat-icon>
        </mat-list-item>
      </ng-container>

      <!-- NIVEAU 2 : Sous-catégories (mode hiérarchique uniquement) -->
      <ng-container *ngIf="currentLevel === 'subcategories' && navigationMode === NavigationMode.Hierarchical">
        <mat-list-item *ngFor="let sub of currentItems" (click)="selectSubCategory(sub)">
          <mat-icon matListIcon>subdirectory_arrow_right</mat-icon>
          <h3 matLine>{{ format(sub.libelle) }}</h3>
          <mat-icon matSuffix>chevron_right</mat-icon>
        </mat-list-item>
      </ng-container>

      <!-- NIVEAU 3 : Référentiels avec badges Baloise -->
      <ng-container *ngIf="currentLevel === 'referentiels'">
        <mat-list-item *ngFor="let ref of currentItems" (click)="selectReferentiel(ref)">
          <mat-icon matListIcon>account_tree</mat-icon>
          <div matLine class="referentiel-content">
            <h3 class="referentiel-title">{{ ref.libelle }}</h3>
            <mat-chip-set class="baloise-badges">
              <mat-chip *ngFor="let category of getBaloiseCategories(ref)" class="baloise-chip">
                {{ category }}
              </mat-chip>
            </mat-chip-set>
          </div>
          <mat-icon matSuffix>chevron_right</mat-icon>
        </mat-list-item>
      </ng-container>

      <!-- NIVEAU 4 : Événements -->
      <ng-container *ngIf="currentLevel === 'events'">
        <button *ngIf="isDialog" mat-flat-button color="primary" (click)="createNewEvent()">
          <mat-icon>add</mat-icon> Créer un nouvel événement
        </button>
        <mat-list-item *ngFor="let event of currentItems" (click)="selectEvent(event)">
          <mat-icon matListIcon>warning</mat-icon>
          <div class="node-content">
            <h3 matLine>{{ event.libelle }}</h3>
          </div>
          <button *ngIf="isDialog" mat-stroked-button color="primary" (click)="selectEvent(event); $event.stopPropagation()">
            <mat-icon>check</mat-icon> Sélectionner
          </button>
        </mat-list-item>
      </ng-container>
    </mat-list>

    <!-- Aucun élément -->
    <div *ngIf="!isLoading && currentItems.length === 0" class="empty">
      <p>Aucun élément trouvé.</p>
    </div>
  </div>
</div>