<div class="container">
  <!-- Header Card -->
  <mat-card class="header-card">
    <mat-card-header>
      <mat-card-title>√Ä faire</mat-card-title>
      <mat-card-subtitle>Tous vos √©l√©ments en attente de traitement</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="stats">
        <mat-chip-set>
          <mat-chip class="stat-chip plans">
            {{ getItemCount(todoEnum.ACTION_PLAN) }} Plans d'action
          </mat-chip>
          <mat-chip class="stat-chip incidents">
            {{ getItemCount(todoEnum.INCIDENT) }} Incidents
          </mat-chip>
          <mat-chip class="stat-chip controls">
            {{ getItemCount(todoEnum.CONTROL) }} Contr√¥les
          </mat-chip>
            <mat-chip class="stat-chip risks">
              {{ getItemCount(todoEnum.RISK) }} Risques
            </mat-chip>
        </mat-chip-set>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Filters Card -->
  <mat-card class="filters-card">
    <mat-card-content>
      <div class="filter-row">
        <!-- View Toggle -->
        <mat-button-toggle-group [(value)]="currentView" class="view-toggle">
          <mat-button-toggle value="grouped">Vue group√©e</mat-button-toggle>
          <mat-button-toggle value="unified">Vue unifi√©e</mat-button-toggle>
        </mat-button-toggle-group>

        <!-- Type Filter -->
        <div class="filter-groups">
          <span class="filter-label">Filtrer :</span>
          <mat-chip-listbox [value]="currentTypeFilter" 
                            (change)="setTypeFilter($event.value)" 
                            class="filter-chips">
            <mat-chip-option *ngFor="let filter of typeFilters" [value]="filter">
              {{ filter.label }}
            </mat-chip-option>
          </mat-chip-listbox>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Content (Version originale) -->
  <div class="content" [class.unified-view]="currentView === 'unified'">

    <!-- Grouped View -->
    <div *ngIf="currentView === 'grouped'">
      <!-- Plans d'action -->
      <div class="group" *ngIf="shouldShowGroup(todoEnum.ACTION_PLAN)"
        [style.display]="currentTypeFilter.value === null || currentTypeFilter.value === todoEnum.ACTION_PLAN ? 'block' : 'none'">
        <div class="group-header" (click)="toggleGroup(todoEnum.ACTION_PLAN)">
          <span>üìã Plans d'action</span>
          <div class="group-header-right">
            <span class="group-count">{{ getFilteredGroupCount(todoEnum.ACTION_PLAN) }}</span>
            <span class="chevron" [class.collapsed]="collapsedGroups[todoEnum.ACTION_PLAN]">‚ñº</span>
          </div>
        </div>
        <div class="group-content" [class.collapsed]="collapsedGroups[todoEnum.ACTION_PLAN]">
          @for(item of getFilteredItems(todoEnum.ACTION_PLAN); track item.id){
          <div (click)="viewItem(item)" class="item" matTooltip="Voir le plan d'action" [style.display]="shouldShowItem(item) ? 'flex' : 'none'">
            <div class="item-type type-plans">Plan</div>
            <div class="item-content">
              <div class="item-title">{{ item.libelle }}</div>
              <div class="item-meta">
                <span>√âch√©ance: {{ item.date | date : "dd/MM/yyyy" }}</span>
              </div>
            </div>
            <div class="item-actions">
              <button class="action-btn" (click)="viewItem(item)">Voir</button>
            </div>
          </div>
          }
        </div>
      </div>

      <!-- Incidents -->
      <div class="group" *ngIf="shouldShowGroup(todoEnum.INCIDENT)"
        [style.display]="currentTypeFilter.value === null || currentTypeFilter.value === todoEnum.INCIDENT ? 'block' : 'none'">
        <div class="group-header" (click)="toggleGroup(todoEnum.INCIDENT)">
          <span>üö® Incidents</span>
          <div class="group-header-right">
            <span class="group-count">{{ getFilteredGroupCount(todoEnum.INCIDENT) }}</span>
            <span class="chevron" [class.collapsed]="collapsedGroups[todoEnum.INCIDENT]">‚ñº</span>
          </div>
        </div>
        <div class="group-content" [class.collapsed]="collapsedGroups[todoEnum.INCIDENT]">
          @for(item of getFilteredItems(todoEnum.INCIDENT); track item.id){
          <div (click)="viewItem(item)" class="item" matTooltip="Traiter l'incident" [style.display]="shouldShowItem(item) ? 'flex' : 'none'">
            <div class="item-type type-incidents">Incident</div>
            <div class="item-content">
              <div class="item-title">{{ item.libelle }}</div>
              <div class="item-meta">
                <span>Cr√©√©: {{ item.date | date : "dd/MM/yyyy" }}</span>
              </div>
            </div>
            <div class="item-actions">
              <button class="action-btn" (click)="viewItem(item)">Traiter</button>
            </div>
          </div>
          }

        </div>
      </div>

      <!-- Contr√¥les -->
      <div class="group" *ngIf="shouldShowGroup(todoEnum.CONTROL)"
        [style.display]="currentTypeFilter.value === null || currentTypeFilter.value === todoEnum.CONTROL ? 'block' : 'none'">
        <div class="group-header" (click)="toggleGroup(todoEnum.CONTROL)">
          <span>‚úì Contr√¥les</span>
          <div class="group-header-right">
            <span class="group-count">{{ getFilteredGroupCount(todoEnum.CONTROL) }}</span>
            <span class="chevron" [class.collapsed]="collapsedGroups[todoEnum.CONTROL]">‚ñº</span>
          </div>
        </div>
        @for(item of getFilteredItems(todoEnum.CONTROL); track item.id){
        <div (click)="viewItem(item)" class="group-content" [class.collapsed]="collapsedGroups[todoEnum.CONTROL]">
          <div class="item" matTooltip="Acc√©der au contr√¥le" [style.display]="shouldShowItem(item) ? 'flex' : 'none'">
            <div class="item-type type-controls">Contr√¥le</div>
            <div class="item-content">
              <div class="item-title">{{ item.libelle }}</div>
              <div class="item-meta">
                <span>Planifi√©: {{ item.date | date : "dd/MM/yyyy" }}</span>
              </div>
            </div>
            <div class="item-actions">
              <button class="action-btn" (click)="viewItem(item)">Acc√©der</button>
            </div>
          </div>
        </div>
        }

      </div>

      <div class="group" *ngIf="shouldShowGroup(todoEnum.RISK)"
        [style.display]="currentTypeFilter.value === null || currentTypeFilter.value === todoEnum.RISK ? 'block' : 'none'">
        <div class="group-header" (click)="toggleGroup(todoEnum.RISK)">
          <span>‚ö†Ô∏è Risques</span>
          <div class="group-header-right">
            <span class="group-count">{{ getFilteredGroupCount(todoEnum.RISK) }}</span>
            <span class="chevron" [class.collapsed]="collapsedGroups[todoEnum.RISK]">‚ñº</span>
          </div>
        </div>
        @for(item of getFilteredItems(todoEnum.RISK); track item.id){
        <div (click)="viewItem(item)" class="group-content" [class.collapsed]="collapsedGroups[todoEnum.RISK]">
          <div class="item" matTooltip="Acc√©der au risque" [style.display]="shouldShowItem(item) ? 'flex' : 'none'">
            <div class="item-type type-controls">Risques</div>
            <div class="item-content">
              <div class="item-title">{{ item.libelle }}</div>
              <div class="item-meta">
                <span>Planifi√©: {{ item.date | date : "dd/MM/yyyy" }}</span>
              </div>
            </div>
            <div class="item-actions">
              <button class="action-btn" (click)="viewItem(item)">Valider</button>
            </div>
          </div>
        </div>
        }

      </div>
    </div>

    <!-- Unified View -->
    <div *ngIf="currentView === 'unified'" class="unified-content">
      <div *ngFor="let item of getAllFilteredItems()" class="item">
        <div class="item-type" [ngClass]="'type-' + getTypeLabel(item.type)">
          {{ getTypeLabel(item.type) }}
        </div>
        <div class="item-content">
          <div class="item-title">{{ item.libelle }}</div>
          <div class="item-meta">
            <span>{{ getDateLabel(item) }}: {{ item.date | date : "dd/MM/yyyy" }}</span>
          </div>
        </div>
        <div class="item-actions">
          <button class="action-btn" (click)="viewItem(item)">
            Voir
          </button>
        </div>
      </div>
    </div>
  </div>
</div>