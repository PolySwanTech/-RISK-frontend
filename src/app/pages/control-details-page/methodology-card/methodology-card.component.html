<div class="methodology-card" *ngIf="!loading">
  <ng-container *ngIf="!methodology; else viewCard">
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>school</mat-icon> Méthodologie appliquée
        </mat-card-title>
        <mat-card-subtitle>Aucune méthodologie enregistrée — veuillez en créer une.</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <form [formGroup]="form" (ngSubmit)="submit()" class="form-grid">
          <mat-form-field appearance="fill">
            <mat-label>Nature du contrôle</mat-label>
            <mat-select formControlName="controlNature" required>
              <mat-option *ngFor="let n of controlNatureValues" [value]="n">
                {{ n | enumLabel: 'controlNature' }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="form.get('controlNature')?.invalid">Requis</mat-error>
          </mat-form-field>

          <mat-form-field appearance="fill">
            <mat-label>Mode d'exécution</mat-label>
            <mat-select formControlName="executionMode" required>
              <mat-option *ngFor="let m of executionModeValues" [value]="m">
                {{ m | enumLabel: 'executionMode' }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="form.get('executionMode')?.invalid">Requis</mat-error>
          </mat-form-field>

          <mat-form-field appearance="fill" class="full">
            <mat-label>Données utilisées</mat-label>
            <textarea
              matInput
              rows="3"
              formControlName="scope"
              placeholder="Ce que couvre le contrôle..."></textarea>
          </mat-form-field>

          <mat-form-field appearance="fill" class="full">
            <mat-label>Échantillon contrôlé</mat-label>
            <textarea
              matInput
              rows="3"
              formControlName="sampling"
              placeholder="Méthode d'échantillonnage..."></textarea>
          </mat-form-field>
        </form>
      </mat-card-content>

      <mat-card-actions align="end">
        <button 
          mat-flat-button 
          color="primary" 
          (click)="submit()" 
          [disabled]="form.invalid || submitting">
          <mat-icon>save</mat-icon>
          {{ submitting ? 'Enregistrement...' : 'Enregistrer la méthodologie' }}
        </button>
      </mat-card-actions>
    </mat-card>
  </ng-container>

  <ng-template #viewCard>
    <mat-card>
      <mat-card-header>
        <mat-card-title>
          <mat-icon>check_circle</mat-icon> Méthodologie appliquée
        </mat-card-title>
      </mat-card-header>

      <mat-card-content class="details-grid">
        <div class="field">
          <label>Nature du contrôle</label>
          <div class="value">{{ methodology?.controlNature | enumLabel: 'controlNature' }}</div>
        </div>

        <div class="field">
          <label>Mode d'exécution</label>
          <div class="value">{{ methodology?.executionMode | enumLabel: 'executionMode' }}</div>
        </div>

        <div class="field full">
          <label>Données utilisées</label>
          <div class="value">{{ methodology?.scope || '—' }}</div>
        </div>

        <div class="field full">
          <label>Échantillon contrôlé</label>
          <div class="value">{{ methodology?.sampling || '—' }}</div>
        </div>
      </mat-card-content>
    </mat-card>
  </ng-template>
</div>

<div class="methodology-card" *ngIf="loading">
  <mat-card class="skeleton">
    <mat-card-content>
      <div class="skeleton-line w60"></div>
      <div class="skeleton-line w40"></div>
      <div class="skeleton-line w90"></div>
      <div class="skeleton-line w80"></div>
    </mat-card-content>
  </mat-card>
</div>