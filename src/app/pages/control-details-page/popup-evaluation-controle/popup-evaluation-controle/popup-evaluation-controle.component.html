<div class="popup-overlay" *ngIf="!showAsCard" (click)="cancel()">
    <div class="rv-modal" [ngClass]="{
    'rv-modal--form': mode === 'FORM',
    'rv-modal--blockers': mode === 'BLOCKERS',
    'rv-modal--details': mode === 'DETAILS'
  }" (click)="$event.stopPropagation()">

        <div class="rv-modal__header">
            <div class="rv-modal__title">
                <span class="rv-emoji">ðŸ§¾</span>
                {{ mode === 'DETAILS' ? "DÃ©tail de lâ€™Ã©valuation"
                : mode === 'FORM' ? "Ã‰valuer le contrÃ´le"
                : "Ã‰valuations en attente" }}
            </div>
            <button class="rv-iconbtn" (click)="cancel()" aria-label="Fermer">Ã—</button>
        </div>

        <div class="rv-modal__body">
            <ng-container [ngSwitch]="mode">

                <div *ngSwitchCase="'BLOCKERS'">
                    <p>Vous devez dâ€™abord Ã©valuer les exÃ©cutions prÃ©cÃ©dentes :</p>

                    <div class="list">
                        <div class="item" *ngFor="let b of blockers">
                            <div class="left">
                                <div class="date">PlanifiÃ©e le {{ b.plannedAt | date: 'dd/MM/yyyy' }}</div>
                                <div class="who">AttribuÃ©e Ã  {{ b.performedBy }}</div>
                                <span class="badge small" [ngClass]="{
                  'status-realise': b.status === 'ACHIEVED',
                  'status-en-cours': b.status === 'IN_PROGRESS',
                  'status-non-realise': b.status === 'NOT_ACHIEVED'
                }">
                                    {{ b.status }}
                                </span>
                            </div>
                            <div class="right">
                                <button class="btn btn-primary" (click)="startEvaluationFor(b.id)">Ã‰valuer
                                    maintenant</button>
                                <button class="btn btn-outline" (click)="openDetails(b.id)">DÃ©tails</button>
                            </div>
                        </div>
                    </div>
                </div>

                <form *ngSwitchCase="'FORM'" (ngSubmit)="submit()" #form="ngForm">
                    <div class="form-group">
                        <label for="evaluation">Ã‰valuation</label>
                        <select [(ngModel)]="evaluationData.evaluation" name="evaluation" required>
                            <option *ngFor="let option of evaluationOptions" [value]="option">
                                {{ labels[option] }}
                            </option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="resume">RÃ©sumÃ©</label>
                        <textarea [(ngModel)]="evaluationData.resume" name="resume" required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="comments">Commentaires</label>
                        <textarea [(ngModel)]="evaluationData.comments" name="comments"></textarea>
                    </div>
                </form>

                <div *ngSwitchCase="'DETAILS'">
                    <ng-container *ngIf="evalDetails; else noEvalYet">

                        <div class="rv-meta-grid">
                            <div class="rv-field">
                                <label>RÃ©alisateur</label>
                                <div class="rv-val">{{ evalDetails.performedBy || 'â€”' }}</div>
                            </div>

                            <div class="rv-field">
                                <label>PlanifiÃ© le</label>
                                <div class="rv-val">
                                    {{ evalDetails.plannedAt ? (evalDetails.plannedAt | date:'dd/MM/yyyy') : 'â€”' }}
                                </div>
                            </div>

                            <div class="rv-field">
                                <label>Ã‰valuÃ© le</label>
                                <div class="rv-val">
                                    {{ evalDetails.evaluatedAt ? (evalDetails.evaluatedAt | date:'dd/MM/yyyy') : 'â€”' }}
                                </div>
                            </div>

                            <div class="rv-field">
                                <label>Ã‰valuation</label>
                                <div class="pill" [ngClass]="{
                  'pill-success': (evalDetails.evaluation || '').toUpperCase().includes('CONF') && !(evalDetails.evaluation || '').toUpperCase().includes('PARTIEL'),
                  'pill-warning': (evalDetails.evaluation || '').toUpperCase().includes('PARTIEL'),
                  'pill-danger': (evalDetails.evaluation || '').toUpperCase().includes('NON'),
                  'pill-default': !(evalDetails.evaluation)
                }">
                                    {{ (evalDetails.evaluation || 'â€”') | uppercase }}
                                </div>
                            </div>

                            <div class="rv-field">
                                <label>Statut de revue</label>
                                <div class="chip" [ngClass]="{
  'pill-success': evalDetails.reviewStatus === 'APPROVED',
  'pill-warning': evalDetails.reviewStatus === 'REEXAM_REQUESTED',
  'pill-default': evalDetails.reviewStatus === 'PENDING' || !evalDetails.reviewStatus
}">
                                    {{ evalDetails.reviewStatus === 'APPROVED' ? 'ValidÃ©e' :
                                    evalDetails.reviewStatus === 'REEXAM_REQUESTED' ? 'RÃ©examen demandÃ©' :
                                    'En attente de validation' }}
                                </div>
                            </div>

                            <div class="rv-field" *ngIf="evalDetails.reviewedAt || evalDetails.reviewedBy">
                                <label>Mise Ã  jour</label>
                                <div class="rv-val meta">
                                    <ng-container *ngIf="evalDetails.reviewedAt">le {{ evalDetails.reviewedAt |
                                        date:'dd/MM/yyyy' }}</ng-container>
                                    <ng-container *ngIf="evalDetails.reviewedBy"><span
                                            *ngIf="evalDetails.reviewedAt">&nbsp;â€¢&nbsp;</span>par {{
                                        evalDetails.reviewedBy }}</ng-container>
                                </div>
                            </div>
                        </div>

                        <hr class="rv-sep" />

                        <div class="rv-section">
                            <div class="rv-section__label">RÃ©sumÃ©</div>
                            <div class="rv-box rv-text">{{ evalDetails.resume || 'â€”' }}</div>
                        </div>

                        <div class="rv-section" *ngIf="evalDetails.comments">
                            <div class="rv-section__label">Commentaires</div>
                            <div class="rv-box rv-text">{{ evalDetails.comments }}</div>
                        </div>

                        <div class="rv-section" *ngIf="canValidate && evalDetails.reviewStatus === 'PENDING'">
                            <div class="rv-section__label">Votre retour (obligatoire)</div>
                            <textarea [(ngModel)]="reviewComment" rows="3" class="rv-textarea"
                                placeholder="Votre avis / dÃ©cision..."></textarea>
                        </div>
                    </ng-container>

                    <ng-template #noEvalYet>
                        <p>Pas dâ€™Ã©valuation soumise pour cette exÃ©cution.</p>
                    </ng-template>
                </div>

            </ng-container>
        </div>

        <div class="rv-modal__footer">
            <ng-container [ngSwitch]="mode">
                <div class="rv-actions" *ngSwitchCase="'BLOCKERS'">
                    <button class="btn btn-secondary" (click)="cancel()">Fermer</button>
                </div>

                <div class="rv-actions" *ngSwitchCase="'FORM'">
                    <button type="submit" class="btn btn-primary" (click)="submit()">Valider</button>
                    <button type="button" class="btn btn-secondary" (click)="cancel()">Fermer</button>
                </div>

                <div class="rv-actions" *ngSwitchCase="'DETAILS'">
                    <ng-container *ngIf="canValidate && evalDetails?.reviewStatus === 'PENDING'; else onlyClose">
                        <button class="btn btn-primary winter-style"
                            [disabled]="evalDetails?.reviewStatus === 'PENDING' && !reviewComment.trim()"
                            (click)="approve()">Valider</button>
                        <button class="btn btn-outline warning"
                            [disabled]="evalDetails?.reviewStatus === 'PENDING' && !reviewComment.trim()"
                            (click)="requestReexam()">Demander un rÃ©examen</button>
                        <button class="btn btn-secondary" (click)="cancel()">Fermer</button>
                    </ng-container>
                    <ng-template #onlyClose>
                        <button class="btn btn-secondary" (click)="cancel()">Fermer</button>
                    </ng-template>
                </div>
            </ng-container>
        </div>

    </div>
</div>

<div class="card eval-card" *ngIf="showAsCard">
    <div class="card-content">
        <h3 class="title">
            <span class="dot"></span>
            ðŸŸ© RÃ©sultats & observations
        </h3>

        <ng-container *ngIf="evaluationView; else noData">
            <div class="eval-header" *ngIf="evaluationView">
                <div class="eval-left">
                    <span class="section-label">Ã‰valuation du contrÃ´le</span>
                    <span class="pill" [ngClass]="evalClass">{{ evalLabel }}</span>
                </div>

                <div class="eval-right">
                    <span class="chip" [ngClass]="reviewBadgeClass">{{ reviewBadgeLabel }}</span>
                    <span class="meta" *ngIf="evaluationView?.evaluatedAt">
                        Ã‰valuÃ©e le {{ evaluationView.evaluatedAt | date:'dd/MM/yyyy' }}
                    </span>
                </div>
            </div>

            <hr class="section-sep" />

            <div class="section">
                <div class="section-label">RÃ©sumÃ© des constats</div>
                <div class="box text">{{ evaluationView.resume || 'â€”' }}</div>
            </div>

            <div class="section">
                <div class="section-label">Commentaires de l'exÃ©cutant</div>
                <div class="box text">{{ evaluationView.comments || 'â€”' }}</div>
            </div>
        </ng-container>

        <ng-template #noData>
            <div class="empty">Aucune Ã©valuation disponible.</div>
        </ng-template>
    </div>
</div>

<div class="card validate-card" *ngIf="showAsCard">
    <div class="card-content">
        <h3 class="title">
            <span class="dot dot--purple"></span>
            ðŸŸª Validation / Approbation
        </h3>

        <ng-container *ngIf="evaluationView && hasValidation; else noValidation">
            <div class="val-grid">
                <div class="val-field">
                    <label>Nom du valideur / manager</label>
                    <div class="val-input">{{ evaluationView.reviewedBy || 'â€”' }}</div>
                </div>

                <div class="val-field">
                    <label>Date de validation</label>
                    <div class="val-input">
                        {{ evaluationView.reviewedAt ? (evaluationView.reviewedAt | date:'dd/MM/yyyy') : 'â€”' }}
                    </div>
                </div>
            </div>

            <div class="val-status">
                <span class="pill" [ngClass]="reviewBadgeClass">{{ reviewBadgeLabel }}</span>
            </div>

            <div class="val-field full">
                <label>Commentaires ou avis du valideur</label>
                <div class="val-textarea">{{ evaluationView.reviewComment || 'â€”' }}</div>
            </div>
        </ng-container>

        <ng-template #noValidation>
            <div class="empty">Aucune validation enregistrÃ©e.</div>
        </ng-template>
    </div>
</div>