@if(!control) {
<div class="loading-spinner">
  <i class="icon-spinner"></i>
  Chargement des d√©tails du contr√¥le...
</div>
}
@else {
<div class="control-details-page">
  <app-go-back [title]="'D√©tails du contr√¥le'" [subtitle]="control.reference" [buttons]="goBackButtons"></app-go-back>

  <div class="main-content">
    <div class="content-grid">
      <div class="main-column">
        <div class="hero-section">
          <!-- === Carte h√©ro (inchang√©e) === -->
          <div class="card is-purple card-overview hero control-hero">
            <div class="card-content">

              <div class="hero-head">
                <h2 class="hero-title">
                  <span class="hero-emoji">üìä</span>
                  Informations g√©n√©rales
                </h2>
              </div>

              <div class="hero-grid">
                <div class="field">
                  <label>Nom du contr√¥le</label>
                  <div class="value">{{ control.libelle || '‚Äî' }}</div>
                </div>

                <div class="field">
                  <label>Processus concern√©</label>
                  <div class="value">{{ control.riskId || '‚Äî' }}</div>
                </div>

                <div class="field">
                  <label>Risque couvert</label>
                  <div class="value">{{ control.riskId || '‚Äî' }}</div>
                </div>

                <div class="field">
                  <label>Responsable du contr√¥le</label>
                  <div class="value">{{ control.creatorId }}</div>
                </div>

                <div class="field">
                  <label>P√©riodicit√©</label>
                  <!-- <div class="value">{{ control ? recurrenceLabels[control.frequency || ''] : '‚Äî' }}</div> -->
                </div>

                <div class="field">
                  <label>Date planifi√©e</label>
                  <div class="value">
                    {{ currentOrLatestExecution?.plannedAt ? (currentOrLatestExecution?.plannedAt | date:'dd/MM/yyyy') :
                    '‚Äî' }}
                  </div>
                </div>

                <div class="field">
                  <label>Date de r√©alisation</label>
                  <div class="value">
                    {{ currentOrLatestExecution?.achievedAt ? (currentOrLatestExecution?.achievedAt | date:'dd/MM/yyyy')
                    :
                    '‚Äî' }}
                  </div>
                </div>

                <div class="field">
                  <label>Statut</label>
                  <div [ngClass]="'badge ' + getStatusClass(currentOrLatestExecution?.status)">
                    {{ currentOrLatestExecution?.status ? formatStatus(currentOrLatestExecution!.status) : '‚Äî' }}
                  </div>
                </div>

                <div class="field full-width">
                  <label>Objectif du contr√¥le</label>
                  <div class="value">{{ control.description || '‚Äî' }}</div>
                </div>
              </div>
            </div>
          </div>

          <div class="methodology-wrapper">
            <app-methodology-card *ngIf="control" [controlId]="control.id" >
            </app-methodology-card>
          </div>
        </div>

        <!-- === Carrousel des ex√©cutions r√©centes (remplace l'historique + actions rapides) === -->
        <div class="carousel" *ngIf="slides.length; else emptyState">
          <div class="carousel-header">
            <h3 class="carousel-title">üïí Ex√©cutions r√©centes</h3>

            <!-- Dots minimalistes (nav secondaire) -->
            <div class="dots">
              <button class="dot" *ngFor="let s of slides; let i = index" [class.active]="i === currentSlide"
                (click)="goTo(i)" [attr.aria-label]="'Aller √† la slide ' + (i + 1)"></button>
            </div>
          </div>
          <div class="carousel-body">
            <!-- Viewport + drag souris/doigt -->
            <div class="carousel-viewport" tabindex="0" (keydown)="onKeydown($event)"
              (pointerdown)="onDragStart($event)" (pointermove)="onDragMove($event)" (pointerup)="onDragEnd($event)"
              (pointerleave)="onDragEnd($event)" (touchstart)="onDragStart($event)" (touchmove)="onDragMove($event)"
              (touchend)="onDragEnd($event)" [class.is-dragging]="isDragging">

              <div class="carousel-track"
                [style.transform]="'translateX(calc(' + (-currentSlide*100) + '% + ' + dragOffsetPx + 'px))'">
                <div class="carousel-slide" *ngFor="let s of slides">
                  <!-- Bandeau m√©ta -->
                  <div class="meta-card card" [ngClass]="computeMetaStripe(s)">
                    <div class="card-content meta">
                      <div class="meta-left">
                        <div class="meta-line">
                          <span class="badge" [ngClass]="getStatusClass(s.exec.status)">{{ formatStatus(s.exec.status)
                            }}</span>
                          <span class="meta-date">Planifi√©e le {{ s.exec.plannedAt | date:'dd/MM/yyyy' }}</span>
                          <span class="meta-date" *ngIf="s.view?.createdAt">‚Ä¢ √âvalu√©e le {{ s.view?.createdAt|
                            date:'dd/MM/yyyy' }}</span>
                          <span class="meta-date" *ngIf="s.view?.reviewedAt">‚Ä¢ Valid√©e le {{ s.view?.reviewedAt |
                            date:'dd/MM/yyyy' }}</span>
                        </div>
                        <div class="meta-sub">Attribu√©e √† {{ s.exec.evaluatorId }}</div>
                      </div>
                      <div class="meta-right">
                        @if((!s.view || s.view.reviewStatus === 'REEXAM_REQUESTED') && sameEvaluator(s.exec.evaluatorId || '')){
                          <button class="btn btn-evaluer"
                                *appHasPermission="'UPDATE_CONTROLE'"
                                (click)="evaluateExec(s.exec.id, 'eval');">
                          {{ s.view?.reviewStatus === 'REEXAM_REQUESTED' ? 'R√©√©valuer' : '√âvaluer' }}
                        </button>
                        }
                      </div>
                    </div>
                  </div>

                  <!-- Cartes visibles seulement quand il y a des donn√©es -->
                  <ng-container *ngIf="s.view">
                    <app-evaluation-card [showAsCard]="true" [evaluationView]="s.view" [canValidate]="true" [executionId]="s.exec.id"
                      (openDetailsRequested)="openEvaluationDetailsPopup(s.exec.id, $event)">
                    </app-evaluation-card>
                  </ng-container>
                </div>
              </div>
            </div>

            <button class="car-fab prev" title="Plus ancien" (click)="prevSlide()" [disabled]="!hasPrev()">‚Äπ</button>
            <button class="car-fab next" title="Plus r√©cent" (click)="nextSlide()" [disabled]="!hasNext()">‚Ä∫</button>
          </div>
        </div>


        <ng-template #emptyState>
          <div class="empty-state">
            <div class="empty-title">Aucune ex√©cution pour le moment</div>
            <div class="empty-sub">Planifiez une premi√®re ex√©cution pour d√©marrer le cycle.</div>
            <!-- Le bouton principal est d√©j√† en haut dans goBackButtons -->
          </div>
        </ng-template>

      </div>
    </div>
  </div>
</div>

<!-- Popups -->
<app-planifier-execution-popup *ngIf="showPopup && control.frequency" [controlId]="control!.id"
  [frequence]="control.frequency!" [isEditing]="false" (close)="showPopup = false"
  (planifier)="handlePlanification($event)" [lastPlannedAt]="controlExecutions?.[0]?.plannedAt">
</app-planifier-execution-popup>
}