@if(!control) {
<div class="loading-spinner">
  <i class="icon-spinner"></i>
  Chargement des d√©tails du contr√¥le...
</div>
}
@else {
<div class="control-details-page">
  <app-go-back [title]="'D√©tails du contr√¥le'" [buttons]="goBackButtons"></app-go-back>

  <div class="main-content">
    <div class="content-grid">
      <div class="main-column">
        <div class="card card-overview hero control-hero">
          <div class="card-content">

            <div class="hero-head">
              <h2 class="hero-title">
                <span class="hero-emoji">üìä</span>
                √âvaluation d'un contr√¥le
              </h2>
              <div class="hero-sub">
                Module de gestion du risque op√©rationnel ‚Äî
                <span>Contr√¥le ID: {{ control.reference }}</span>
              </div>
            </div>

            <div class="hero-grid">
              <div class="field">
                <label>Nom du contr√¥le</label>
                <div class="value">{{ control.libelle || '‚Äî' }}</div>
              </div>

              <div class="field">
                <label>Processus concern√©</label>
                <div class="value">{{ control.processName || '‚Äî' }}</div>
              </div>

              <div class="field field--textarea">
                <label>Objectif du contr√¥le</label>
                <div class="value multiline">{{ control.description || '‚Äî' }}</div>
              </div>

              <div class="field">
                <label>Responsable du contr√¥le</label>
                <div class="value">{{ control.responsable || control.creator || '‚Äî' }}</div>
              </div>

              <div class="field">
                <label>P√©riodicit√©</label>
                <div class="value">{{ control ? recurenceLabels[control.frequency] : '‚Äî' }}</div>
              </div>

              <div class="field">
                <label>Date planifi√©e</label>
                <div class="value"> {{ currentOrLatestExecution?.plannedAt ? (currentOrLatestExecution?.plannedAt |
                  date:'dd/MM/yyyy') : '‚Äî' }}
                </div>
              </div>

              <div class="field">
                <label>Date de r√©alisation</label>
                <div class="value"> {{ currentOrLatestExecution?.achievedAt ? (currentOrLatestExecution?.achievedAt |
                  date:'dd/MM/yyyy') : '‚Äî' }}
                </div>
              </div>

              <div class="field">
                <label>Statut</label>
                <div class="status-pill" [ngClass]="getStatusClass(control.execution?.status)">
                  {{ currentOrLatestExecution?.status ? formatStatus(currentOrLatestExecution!.status) : '‚Äî' }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <app-popup-evaluation-controle [showAsCard]="true" [evaluationView]="lastEvaluation">
        </app-popup-evaluation-controle>

      </div>

      <div class="sidebar">
        <div class="card">
          <div class="card-content">
            <h3 class="card-title">
              <i class="icon-activity"></i>
              Historique des ex√©cutions
            </h3>

            <div class="executions-list">
              <div class="execution-item" *ngFor="let execution of controlExecutions"
                [class.disabled]="execution.status === ControlStatus.ACHIEVED" [ngClass]="{
                     'item-inprogress': execution.status === ControlStatus.IN_PROGRESS,
                     'item-achieved': execution.status === ControlStatus.ACHIEVED,
                     'item-notachieved': execution.status === ControlStatus.NOT_ACHIEVED,
                     'is-active': hasEvaluation(execution.id) && getReviewStatus(execution.id) === 'PENDING',
                     'is-selected': selectedExecId === execution.id
                   }">

                <div class="execution-select" (click)="$event.stopPropagation()">
                  <label class="radio-wrap"
                    [attr.aria-label]="'S√©lectionner l\'ex√©cution du ' + (execution.plannedAt | date:'dd/MM/yyyy')">
                    <input type="radio" name="execSel" [value]="execution.id"
                      [checked]="selectedExecId === execution.id" (click)="toggleSelection(execution.id)" />
                    <span class="dot" aria-hidden="true"></span>
                  </label>
                </div>

                <div class="execution-info">
                  <div class="execution-date clickable" role="button" tabindex="0" (click)="editExecution(execution)"
                    (keydown.enter)="editExecution(execution)" (keydown.space)="editExecution(execution)">
                    <i class="icon-calendar"></i>
                    <strong>Planifi√©e le {{ execution.plannedAt | date : "dd/MM/yyyy" }}</strong>
                  </div>

                  <div class="execution-responsible">
                    Attribu√©e √† {{ execution.performedBy }}
                  </div>

                  <div class="execution-eval" *ngIf="hasEvaluation(execution.id)">
                    <div class="eval-line">
                      üìã √âvaluer le {{ getEvaluatedAt(execution.id) | date : "dd/MM/yyyy" }}
                      <span *ngIf="getReexamIndex(execution.id) > 0" class="rv-chip rv-chip--secondary"
                        style="margin-left:8px; display: block;">
                        R√©examen n¬∞{{ getReexamIndex(execution.id) }}
                      </span>
                    </div>

                    <ng-container [ngSwitch]="getReviewStatus(execution.id)">
                      <span *ngSwitchCase="'PENDING'" class="rv-chip rv-chip--warning">EN ATTENTE DE VALIDATION</span>
                      <span *ngSwitchCase="'APPROVED'" class="rv-chip rv-chip--success">VALID√âE</span>
                      <span *ngSwitchCase="'REEXAM_REQUESTED'" class="rv-chip rv-chip--info">R√âEXAMEN DEMAND√â</span>
                    </ng-container>

                    <div class="eval-review-meta"
                      *ngIf="getReviewStatus(execution.id) === 'APPROVED' && getReviewedAt(execution.id)">
                      <div class="eval-line">‚úî Valid√©e le {{ getReviewedAt(execution.id) | date : 'dd/MM/yyyy' }}</div>
                      <div *ngIf="getReviewedBy(execution.id)">par {{ getReviewedBy(execution.id) }}</div>
                    </div>

                    <div class="eval-review-meta"
                      *ngIf="getReviewStatus(execution.id) === 'REEXAM_REQUESTED' && getReviewedAt(execution.id)">
                      <div class="eval-line">R√©examen demand√© le {{ getReviewedAt(execution.id) | date : 'dd/MM/yyyy' }}
                      </div>
                      <div *ngIf="getReviewedBy(execution.id)">par {{ getReviewedBy(execution.id) }}</div>
                    </div>
                  </div>
                </div>

                <div class="execution-status" (click)="$event.stopPropagation()">
                  <span class="badge small" [ngClass]="getStatusClass(execution.status)">
                    {{ formatStatus(execution.status) }}
                  </span>

                  <button class="btn-link btn-d√©tail" *ngIf="hasEvaluation(execution.id)"
                    (click)="openEvaluationDetailsPopup(execution.id)">
                    D√©tails
                  </button>
                </div>

              </div>
            </div>
            <div class="btn-history">
              <button class="btn-link full-width" (click)="viewFullHistory()">
                Voir tout l'historique
              </button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-content">
            <h3 class="card-title">Actions rapides</h3>
            <div class="quick-actions">
              <button class="btn btn-outline full-width" *ngIf="selectedExec && canMarkAsRealized()"
                (click)="markAsRealized()">
                <i class="icon-check-circle"></i>
                Marquer comme r√©alis√©
              </button>
              <button class="btn btn-outline full-width" (click)="scheduleExecution()">
                <i class="icon-calendar"></i>
                Planifier ex√©cution
              </button>
              <button class="btn btn-outline full-width" (click)="addNote()">
                <i class="icon-file-text"></i>
                Ajouter une note
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<app-planifier-execution-popup *ngIf="showPopup" [controlId]="control!.id.id" [controlVersion]="control!.id.version"
  [frequence]="control!.frequency" [isEditing]="selectedExecutionToEdit !== null"
  [executionToEdit]="selectedExecutionToEdit!" (close)="showPopup = false; selectedExecutionToEdit = null"
  (planifier)="handlePlanification($event)" [lastPlannedAt]="controlExecutions?.[0]?.plannedAt">
</app-planifier-execution-popup>

<app-popup-evaluation-controle *ngIf="showEvaluationPopup && selectedExecutionId" [executionId]="selectedExecutionId!"
  [initialMode]="forceDetails ? 'DETAILS' : undefined" [canValidate]="isValidator()"
  (submitted)="handleEvaluationSubmitted()" (reviewed)="handleEvaluationSubmitted()"
  (close)="showEvaluationPopup = false">
</app-popup-evaluation-controle>

}