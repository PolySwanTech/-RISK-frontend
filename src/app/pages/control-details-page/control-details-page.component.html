@if(!control) {
<div class="loading-spinner">
  <i class="icon-spinner"></i>
  Chargement des dÃ©tails du contrÃ´le...
</div>
}
@else {
<div class="control-details-page">
  <app-go-back [title]="'DÃ©tails du contrÃ´le'" [buttons]="goBackButtons"></app-go-back>

  <div class="main-content">
    <div class="content-grid">
      <!-- Colonne principale -->
      <div class="main-column">
        <!-- Informations gÃ©nÃ©rales : HERO -->
        <div class="card card-overview hero control-hero">
          <div class="card-content">

            <!-- Titre + sous-titre -->
            <div class="hero-head">
              <h2 class="hero-title">
                <span class="hero-emoji">ðŸ“Š</span>
                Ã‰valuation d'un contrÃ´le
              </h2>
              <div class="hero-sub">
                Module de gestion du risque opÃ©rationnel â€”
                <span>ContrÃ´le ID: {{ control.reference }}</span>
              </div>
            </div>

            <!-- Grille des champs (copie du 3e screen) -->
            <div class="hero-grid">
              <div class="field">
                <label>Nom du contrÃ´le</label>
                <div class="value">{{ control.libelle || 'â€”' }}</div>
              </div>

              <div class="field">
                <label>Processus concernÃ©</label>
                <div class="value">{{ control.processName || 'â€”' }}</div>
              </div>

              <div class="field field--textarea">
                <label>Objectif du contrÃ´le</label>
                <div class="value multiline">{{ control.description || 'â€”' }}</div>
              </div>

              <div class="field">
                <label>Responsable du contrÃ´le</label>
                <div class="value">{{ control.responsable || control.creator || 'â€”' }}</div>
              </div>

              <div class="field">
                <label>PÃ©riodicitÃ©</label>
                <div class="value">{{ control ? recurenceLabels[control.frequency] : 'â€”' }}</div>
              </div>

              <div class="field">
                <label>Date planifiÃ©e</label>
                <div class="value">{{ control.execution?.plannedAt ? (control.execution?.plannedAt | date:'dd/MM/yyyy')
                  : 'â€”' }}
                </div>
              </div>

              <div class="field">
                <label>Date de rÃ©alisation</label>
                <div class="value">{{ control.execution?.achievedAt ? (control.execution?.achievedAt |
                  date:'dd/MM/yyyy')
                  : 'â€”' }}</div>
              </div>

              <div class="field">
                <label>Statut</label>
                <div class="status-pill" [ngClass]="getStatusClass(control.execution?.status)">
                  {{ control.execution?.status ? formatStatus(control!.execution!.status) : 'â€”' }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Carte â€œRÃ©sultats & observationsâ€ (derniÃ¨re Ã©valuation) -->
        <app-popup-evaluation-controle [showAsCard]="true" [evaluationView]="lastEvaluation">
        </app-popup-evaluation-controle>

      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Historique des exÃ©cutions -->
        <div class="card">
          <div class="card-content">
            <h3 class="card-title">
              <i class="icon-activity"></i>
              Historique des exÃ©cutions
            </h3>

            <div class="executions-list">
              <div class="execution-item" *ngFor="let execution of controlExecutions"
                [class.disabled]="execution.status === ControlStatus.ACHIEVED" [ngClass]="{
                     'item-inprogress': execution.status === ControlStatus.IN_PROGRESS,
                     'item-achieved': execution.status === ControlStatus.ACHIEVED,
                     'item-notachieved': execution.status === ControlStatus.NOT_ACHIEVED,
                     'is-active': hasEvaluation(execution.id) && getReviewStatus(execution.id) === 'PENDING'
                   }">

                <div class="execution-info">
                  <!-- Ligne 1 : planification -->
                  <div class="execution-date clickable" role="button" tabindex="0" (click)="editExecution(execution)"
                    (keydown.enter)="editExecution(execution)" (keydown.space)="editExecution(execution)">
                    <i class="icon-calendar"></i>
                    <strong>PlanifiÃ©e le {{ execution.plannedAt | date : "dd/MM/yyyy" }}</strong>
                  </div>

                  <!-- Ligne 2 : attribution (personne assignÃ©e) -->
                  <div class="execution-responsible">
                    AttribuÃ©e Ã  {{ execution.performedBy }}
                  </div>

                  <!-- Retard (seulement si validÃ©e et en retard) -->
                  <!-- <div class="execution-late" *ngIf="execution.status === ControlStatus.ACHIEVED && isLate(execution)">
                    <i class="icon-alert-triangle"></i>
                    Retard de {{ delayDays(execution) }} jours
                  </div> -->

                  <!-- Ligne 3 : info Ã©valuation si existante -->
                  <div class="execution-eval" *ngIf="hasEvaluation(execution.id)">
                    <div class="eval-line">
                      ðŸ“‹ Ã‰valuer le {{ getEvaluatedAt(execution.id) | date : "dd/MM/yyyy" }}
                      <span *ngIf="getReexamIndex(execution.id) > 0" class="rv-chip rv-chip--secondary"
                        style="margin-left:8px;">
                        RÃ©examen nÂ°{{ getReexamIndex(execution.id) }}
                      </span>
                    </div>

                    <ng-container [ngSwitch]="getReviewStatus(execution.id)">
                      <span *ngSwitchCase="'PENDING'" class="rv-chip rv-chip--warning">EN ATTENTE DE VALIDATION</span>
                      <span *ngSwitchCase="'APPROVED'" class="rv-chip rv-chip--success">VALIDÃ‰E</span>
                      <span *ngSwitchCase="'REEXAM_REQUESTED'" class="rv-chip rv-chip--info">RÃ‰EXAMEN DEMANDÃ‰</span>
                    </ng-container>

                    <!-- APPROVED -->
                    <div class="eval-review-meta"
                      *ngIf="getReviewStatus(execution.id) === 'APPROVED' && getReviewedAt(execution.id)">
                      <div class="eval-line">âœ” ValidÃ©e le {{ getReviewedAt(execution.id) | date : 'dd/MM/yyyy' }}</div>
                      <div *ngIf="getReviewedBy(execution.id)">par {{ getReviewedBy(execution.id) }}</div>
                    </div>

                    <!-- REEXAM_REQUESTED -->
                    <div class="eval-review-meta"
                      *ngIf="getReviewStatus(execution.id) === 'REEXAM_REQUESTED' && getReviewedAt(execution.id)">
                      <div class="eval-line">RÃ©examen demandÃ© le {{ getReviewedAt(execution.id) | date : 'dd/MM/yyyy' }}
                      </div>
                      <div *ngIf="getReviewedBy(execution.id)">par {{ getReviewedBy(execution.id) }}</div>
                    </div>
                  </div>
                </div>

                <div class="execution-status" (click)="$event.stopPropagation()">
                  <span class="badge small" [ngClass]="getStatusClass(execution.status)">
                    {{ formatStatus(execution.status) }}
                  </span>

                  <button class="btn-link btn-dÃ©tail" *ngIf="hasEvaluation(execution.id)"
                    (click)="openEvalDetails(execution)">
                    DÃ©tails
                  </button>
                </div>

              </div>
            </div>
            <div class="btn-history">
              <button class="btn-link full-width" (click)="viewFullHistory()">
                Voir tout l'historique
              </button>
            </div>
          </div>
        </div>

        <!-- Actions rapides -->
        <div class="card">
          <div class="card-content">
            <h3 class="card-title">Actions rapides</h3>
            <div class="quick-actions">
              <button class="btn btn-outline full-width" *ngIf="canMarkAsRealized()" (click)="markAsRealized()">
                <i class="icon-check-circle"></i>
                Marquer comme rÃ©alisÃ©
              </button>
              <button class="btn btn-outline full-width" (click)="scheduleExecution()">
                <i class="icon-calendar"></i>
                Planifier exÃ©cution
              </button>
              <button class="btn btn-outline full-width" (click)="addNote()">
                <i class="icon-file-text"></i>
                Ajouter une note
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-container *ngIf="showBlockersPopup">
    <div class="popup-overlay">
      <div class="popup-container">
        <h2>Ã‰valuations en attente</h2>
        <p>Vous devez dâ€™abord Ã©valuer les exÃ©cutions prÃ©cÃ©dentes :</p>

        <div class="list">
          <div class="item" *ngFor="let b of blockers">
            <div class="left">
              <div class="date">PlanifiÃ©e le {{ b.plannedAt | date: 'dd/MM/yyyy' }}</div>
              <div class="who">AttribuÃ©e Ã  {{ b.performedBy }}</div>
              <span class="badge small" [ngClass]="getStatusClass(b.status)">
                {{ formatStatus(b.status) }}
              </span>
            </div>
            <div class="right">
              <button class="btn btn-primary" (click)="openEvaluationFor(b.id)">Ã‰valuer maintenant</button>
            </div>
          </div>
        </div>

        <div class="popup-actions">
          <button class="btn btn-secondary" (click)="showBlockersPopup = false">Fermer</button>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-container *ngIf="showEvalDetailsPopup && evalDetails">
    <div class="popup-overlay" (click)="showEvalDetailsPopup = false">
      <div class="rv-modal" (click)="$event.stopPropagation()">

        <div class="rv-modal__header">
          <div class="rv-modal__title">
            <span class="rv-emoji">ðŸ§¾</span>
            DÃ©tail de lâ€™Ã©valuation
          </div>
          <button class="rv-iconbtn" (click)="showEvalDetailsPopup = false" aria-label="Fermer">Ã—</button>
        </div>

        <div class="rv-modal__body">

          <div class="rv-meta-grid">
            <div class="rv-field">
              <label>RÃ©alisateur</label>
              <div class="rv-val">{{ evalDetails.performedBy || 'â€”' }}</div>
            </div>

            <div class="rv-field">
              <label>PlanifiÃ© le</label>
              <div class="rv-val">
                {{ evalDetails.plannedAt ? (evalDetails.plannedAt | date:'dd/MM/yyyy') : 'â€”' }}
              </div>
            </div>

            <div class="rv-field">
              <label>Ã‰valuÃ© le</label>
              <div class="rv-val">
                {{ evalDetails.evaluatedAt ? (evalDetails.evaluatedAt | date:'dd/MM/yyyy') : 'â€”' }}
              </div>
            </div>

            <div class="rv-field">
              <label>Ã‰valuation</label>
              <div class="pill" [ngClass]="{
              'pill-success': (evalDetails.evaluation || '').toUpperCase().includes('CONFORME') && !(evalDetails.evaluation || '').toUpperCase().includes('PARTIEL'),
              'pill-warning': (evalDetails.evaluation || '').toUpperCase().includes('PARTIEL'),
              'pill-danger':  (evalDetails.evaluation || '').toUpperCase().includes('NON')
            }">
                {{ (evalDetails.evaluation || 'â€”') | uppercase }}
              </div>
            </div>

            <div class="rv-field">
              <label>Statut de revue</label>
              <div class="chip" [ngClass]="getReviewChipClass(evalDetails.reviewStatus)">
                {{ getReviewChipLabel(evalDetails.reviewStatus) }}
              </div>
            </div>

            <div class="rv-field" *ngIf="evalDetails.reviewedAt || evalDetails.reviewedBy">
              <label>Mise Ã  jour</label>
              <div class="rv-val meta">
                <ng-container *ngIf="evalDetails.reviewedAt">
                  le {{ evalDetails.reviewedAt | date:'dd/MM/yyyy' }}
                </ng-container>
                <ng-container *ngIf="evalDetails.reviewedBy">
                  <span *ngIf="evalDetails.reviewedAt">&nbsp;â€¢&nbsp;</span>par {{ evalDetails.reviewedBy }}
                </ng-container>
              </div>
            </div>
          </div>

          <hr class="rv-sep">

          <div class="rv-section">
            <div class="rv-section__label">RÃ©sumÃ©</div>
            <div class="rv-box rv-text">{{ evalDetails.resume || 'â€”' }}</div>
          </div>

          <div class="rv-section" *ngIf="evalDetails.comments">
            <div class="rv-section__label">Commentaires</div>
            <div class="rv-box rv-text">{{ evalDetails.comments }}</div>
          </div>

          <div class="rv-section" *ngIf="isValidator() && pendingReview()">
            <div class="rv-section__label">Votre retour (obligatoire)</div>
            <textarea [(ngModel)]="reviewComment" class="rv-textarea" rows="3"
              placeholder="Votre avis / dÃ©cision..."></textarea>
          </div>
        </div>

        <div class="rv-modal__footer">
          <div class="rv-actions" *ngIf="isValidator(); else footerCloseOnly">
            <button class="btn btn-primary" [disabled]="pendingReview() && !reviewComment.trim()"
              (click)="approveEvaluation()">
              âœ… Valider
            </button>
            <button class="btn btn-outline warning" [disabled]="pendingReview() && !reviewComment.trim()"
              (click)="requestReexam()">
              ðŸ”„ Demander un rÃ©examen
            </button>
            <button class="btn btn-secondary" (click)="showEvalDetailsPopup = false">Fermer</button>
          </div>
          <ng-template #footerCloseOnly>
            <div class="rv-actions">
              <button class="btn btn-secondary" (click)="showEvalDetailsPopup = false">Fermer</button>
            </div>
          </ng-template>
        </div>

      </div>
    </div>
  </ng-container>


</div>

<app-planifier-execution-popup *ngIf="showPopup" [controlId]="control!.id.id" [controlVersion]="control!.id.version"
  [frequence]="control!.frequency" [isEditing]="selectedExecutionToEdit !== null"
  [executionToEdit]="selectedExecutionToEdit!" (close)="showPopup = false; selectedExecutionToEdit = null"
  (planifier)="handlePlanification($event)">
</app-planifier-execution-popup>

<app-popup-evaluation-controle *ngIf="showEvaluationPopup" [executionId]="selectedExecutionId!"
  (close)="showEvaluationPopup = false" (submitted)="handleEvaluationSubmitted()">
</app-popup-evaluation-controle>
}