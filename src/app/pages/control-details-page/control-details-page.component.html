@if(!control) {
<div class="loading-spinner">
  <i class="icon-spinner"></i>
  Chargement des d√©tails du contr√¥le...
</div>
}
@else {
<div class="control-details-page">
  <app-go-back [title]="'D√©tails du contr√¥le'" [buttons]="goBackButtons"></app-go-back>

  <div class="main-content">
    <div class="content-grid">
      <!-- Colonne principale -->
      <div class="main-column">
        <!-- Informations g√©n√©rales : HERO -->
        <div class="card card-overview hero control-hero">
          <div class="card-content">

            <!-- Titre + sous-titre -->
            <div class="hero-head">
              <h2 class="hero-title">
                <span class="hero-emoji">üìä</span>
                √âvaluation d'un contr√¥le
              </h2>
              <div class="hero-sub">
                Module de gestion du risque op√©rationnel ‚Äî
                <span>Contr√¥le ID: {{ control.reference }}</span>
              </div>
            </div>

            <!-- Grille des champs (copie du 3e screen) -->
            <div class="hero-grid">
              <div class="field">
                <label>Nom du contr√¥le</label>
                <div class="value">{{ control.libelle || '‚Äî' }}</div>
              </div>

              <div class="field">
                <label>Processus concern√©</label>
                <div class="value">{{ control.processName || '‚Äî' }}</div>
              </div>

              <div class="field field--textarea">
                <label>Objectif du contr√¥le</label>
                <div class="value multiline">{{ control.description || '‚Äî' }}</div>
              </div>

              <div class="field">
                <label>Responsable du contr√¥le</label>
                <div class="value">{{ control.responsable || control.creator || '‚Äî' }}</div>
              </div>

              <div class="field">
                <label>P√©riodicit√©</label>
                <div class="value">{{ control ? recurenceLabels[control.frequency] : '‚Äî' }}</div>
              </div>

              <div class="field">
                <label>Date planifi√©e</label>
                <div class="value">{{ control.execution?.plannedAt ? (control.execution?.plannedAt | date:'dd/MM/yyyy')
                  : '‚Äî' }}
                </div>
              </div>

              <div class="field">
                <label>Date de r√©alisation</label>
                <div class="value">{{ control.execution?.achievedAt ? (control.execution?.achievedAt |
                  date:'dd/MM/yyyy')
                  : '‚Äî' }}</div>
              </div>

              <div class="field">
                <label>Statut</label>
                <div class="status-pill" [ngClass]="getStatusClass(control.execution?.status)">
                  {{ control.execution?.status ? formatStatus(control!.execution!.status) : '‚Äî' }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Carte ‚ÄúR√©sultats & observations‚Äù (derni√®re √©valuation) -->
        <app-popup-evaluation-controle [showAsCard]="true" [evaluationView]="lastEvaluation">
        </app-popup-evaluation-controle>

      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Historique des ex√©cutions -->
        <div class="card">
          <div class="card-content">
            <h3 class="card-title">
              <i class="icon-activity"></i>
              Historique des ex√©cutions
            </h3>

            <div class="executions-list">
              <div class="execution-item" *ngFor="let execution of controlExecutions"
                [class.disabled]="execution.status === ControlStatus.ACHIEVED" [ngClass]="{
                     'item-inprogress': execution.status === ControlStatus.IN_PROGRESS,
                     'item-achieved': execution.status === ControlStatus.ACHIEVED,
                     'item-notachieved': execution.status === ControlStatus.NOT_ACHIEVED,
                     'is-active': hasEvaluation(execution.id) && getReviewStatus(execution.id) === 'PENDING'
                   }">

                <div class="execution-info">
                  <!-- Ligne 1 : planification -->
                  <div class="execution-date clickable" role="button" tabindex="0" (click)="editExecution(execution)"
                    (keydown.enter)="editExecution(execution)" (keydown.space)="editExecution(execution)">
                    <i class="icon-calendar"></i>
                    <strong>Planifi√©e le {{ execution.plannedAt | date : "dd/MM/yyyy" }}</strong>
                  </div>

                  <!-- Ligne 2 : attribution (personne assign√©e) -->
                  <div class="execution-responsible">
                    Attribu√©e √† {{ execution.performedBy }}
                  </div>

                  <!-- Retard (seulement si valid√©e et en retard) -->
                  <!-- <div class="execution-late" *ngIf="execution.status === ControlStatus.ACHIEVED && isLate(execution)">
                    <i class="icon-alert-triangle"></i>
                    Retard de {{ delayDays(execution) }} jours
                  </div> -->

                  <!-- Ligne 3 : info √©valuation si existante -->
                  <div class="execution-eval" *ngIf="hasEvaluation(execution.id)">
                    <div class="eval-line">
                      üìã √âvaluer le {{ getEvaluatedAt(execution.id) | date : "dd/MM/yyyy" }}
                      <span *ngIf="getReexamIndex(execution.id) > 0" class="rv-chip rv-chip--secondary"
                        style="margin-left:8px;">
                        R√©examen n¬∞{{ getReexamIndex(execution.id) }}
                      </span>
                    </div>

                    <ng-container [ngSwitch]="getReviewStatus(execution.id)">
                      <span *ngSwitchCase="'PENDING'" class="rv-chip rv-chip--warning">EN ATTENTE DE VALIDATION</span>
                      <span *ngSwitchCase="'APPROVED'" class="rv-chip rv-chip--success">VALID√âE</span>
                      <span *ngSwitchCase="'REEXAM_REQUESTED'" class="rv-chip rv-chip--info">R√âEXAMEN DEMAND√â</span>
                    </ng-container>

                    <!-- APPROVED -->
                    <div class="eval-review-meta"
                      *ngIf="getReviewStatus(execution.id) === 'APPROVED' && getReviewedAt(execution.id)">
                      <div class="eval-line">‚úî Valid√©e le {{ getReviewedAt(execution.id) | date : 'dd/MM/yyyy' }}</div>
                      <div *ngIf="getReviewedBy(execution.id)">par {{ getReviewedBy(execution.id) }}</div>
                    </div>

                    <!-- REEXAM_REQUESTED -->
                    <div class="eval-review-meta"
                      *ngIf="getReviewStatus(execution.id) === 'REEXAM_REQUESTED' && getReviewedAt(execution.id)">
                      <div class="eval-line">R√©examen demand√© le {{ getReviewedAt(execution.id) | date : 'dd/MM/yyyy' }}
                      </div>
                      <div *ngIf="getReviewedBy(execution.id)">par {{ getReviewedBy(execution.id) }}</div>
                    </div>
                  </div>
                </div>

                <div class="execution-status" (click)="$event.stopPropagation()">
                  <span class="badge small" [ngClass]="getStatusClass(execution.status)">
                    {{ formatStatus(execution.status) }}
                  </span>

                  <button class="btn-link btn-d√©tail" *ngIf="hasEvaluation(execution.id)"
                    (click)="openEvalDetails(execution)">
                    D√©tails
                  </button>
                </div>

              </div>
            </div>
            <div class="btn-history">
              <button class="btn-link full-width" (click)="viewFullHistory()">
                Voir tout l'historique
              </button>
            </div>
          </div>
        </div>

        <!-- Actions rapides -->
        <div class="card">
          <div class="card-content">
            <h3 class="card-title">Actions rapides</h3>
            <div class="quick-actions">
              <button class="btn btn-outline full-width" *ngIf="canMarkAsRealized()" (click)="markAsRealized()">
                <i class="icon-check-circle"></i>
                Marquer comme r√©alis√©
              </button>
              <button class="btn btn-outline full-width" (click)="scheduleExecution()">
                <i class="icon-calendar"></i>
                Planifier ex√©cution
              </button>
              <button class="btn btn-outline full-width" (click)="addNote()">
                <i class="icon-file-text"></i>
                Ajouter une note
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-container *ngIf="showBlockersPopup">
    <div class="popup-overlay">
      <div class="popup-container">
        <h2>√âvaluations en attente</h2>
        <p>Vous devez d‚Äôabord √©valuer les ex√©cutions pr√©c√©dentes :</p>

        <div class="list">
          <div class="item" *ngFor="let b of blockers">
            <div class="left">
              <div class="date">Planifi√©e le {{ b.plannedAt | date: 'dd/MM/yyyy' }}</div>
              <div class="who">Attribu√©e √† {{ b.performedBy }}</div>
              <span class="badge small" [ngClass]="getStatusClass(b.status)">
                {{ formatStatus(b.status) }}
              </span>
            </div>
            <div class="right">
              <button class="btn btn-primary" (click)="openEvaluationFor(b.id)">√âvaluer maintenant</button>
            </div>
          </div>
        </div>

        <div class="popup-actions">
          <button class="btn btn-secondary" (click)="showBlockersPopup = false">Fermer</button>
        </div>
      </div>
    </div>
  </ng-container>

  <ng-container *ngIf="showEvalDetailsPopup && evalDetails">
    <div class="popup-overlay" (click)="showEvalDetailsPopup = false">
      <div class="rv-modal" (click)="$event.stopPropagation()">

        <div class="rv-modal__header">
          <div class="rv-modal__title">
            <span class="rv-emoji">üßæ</span>
            D√©tail de l‚Äô√©valuation
          </div>
          <button class="rv-iconbtn" (click)="showEvalDetailsPopup = false" aria-label="Fermer">√ó</button>
        </div>

        <div class="rv-modal__body">

          <div class="rv-meta-grid">
            <div class="rv-field">
              <label>R√©alisateur</label>
              <div class="rv-val">{{ evalDetails.performedBy || '‚Äî' }}</div>
            </div>

            <div class="rv-field">
              <label>Planifi√© le</label>
              <div class="rv-val">
                {{ evalDetails.plannedAt ? (evalDetails.plannedAt | date:'dd/MM/yyyy') : '‚Äî' }}
              </div>
            </div>

            <div class="rv-field">
              <label>√âvalu√© le</label>
              <div class="rv-val">
                {{ evalDetails.evaluatedAt ? (evalDetails.evaluatedAt | date:'dd/MM/yyyy') : '‚Äî' }}
              </div>
            </div>

            <div class="rv-field">
              <label>√âvaluation</label>
              <div class="pill" [ngClass]="{
              'pill-success': (evalDetails.evaluation || '').toUpperCase().includes('CONFORME') && !(evalDetails.evaluation || '').toUpperCase().includes('PARTIEL'),
              'pill-warning': (evalDetails.evaluation || '').toUpperCase().includes('PARTIEL'),
              'pill-danger':  (evalDetails.evaluation || '').toUpperCase().includes('NON')
            }">
                {{ (evalDetails.evaluation || '‚Äî') | uppercase }}
              </div>
            </div>

            <div class="rv-field">
              <label>Statut de revue</label>
              <div class="chip" [ngClass]="getReviewChipClass(evalDetails.reviewStatus)">
                {{ getReviewChipLabel(evalDetails.reviewStatus) }}
              </div>
            </div>

            <div class="rv-field" *ngIf="evalDetails.reviewedAt || evalDetails.reviewedBy">
              <label>Mise √† jour</label>
              <div class="rv-val meta">
                <ng-container *ngIf="evalDetails.reviewedAt">
                  le {{ evalDetails.reviewedAt | date:'dd/MM/yyyy' }}
                </ng-container>
                <ng-container *ngIf="evalDetails.reviewedBy">
                  <span *ngIf="evalDetails.reviewedAt">&nbsp;‚Ä¢&nbsp;</span>par {{ evalDetails.reviewedBy }}
                </ng-container>
              </div>
            </div>
          </div>

          <hr class="rv-sep">

          <div class="rv-section">
            <div class="rv-section__label">R√©sum√©</div>
            <div class="rv-box rv-text">{{ evalDetails.resume || '‚Äî' }}</div>
          </div>

          <div class="rv-section" *ngIf="evalDetails.comments">
            <div class="rv-section__label">Commentaires</div>
            <div class="rv-box rv-text">{{ evalDetails.comments }}</div>
          </div>

          <div class="rv-section" *ngIf="isValidator() && pendingReview()">
            <div class="rv-section__label">Votre retour (obligatoire)</div>
            <textarea [(ngModel)]="reviewComment" class="rv-textarea" rows="3"
              placeholder="Votre avis / d√©cision..."></textarea>
          </div>
        </div>

        <div class="rv-modal__footer">
          <div class="rv-actions" *ngIf="isValidator(); else footerCloseOnly">
            <button class="btn btn-primary" [disabled]="pendingReview() && !reviewComment.trim()"
              (click)="approveEvaluation()">
              ‚úÖ Valider
            </button>
            <button class="btn btn-outline warning" [disabled]="pendingReview() && !reviewComment.trim()"
              (click)="requestReexam()">
              üîÑ Demander un r√©examen
            </button>
            <button class="btn btn-secondary" (click)="showEvalDetailsPopup = false">Fermer</button>
          </div>
          <ng-template #footerCloseOnly>
            <div class="rv-actions">
              <button class="btn btn-secondary" (click)="showEvalDetailsPopup = false">Fermer</button>
            </div>
          </ng-template>
        </div>

      </div>
    </div>
  </ng-container>


</div>

<app-planifier-execution-popup *ngIf="showPopup" [controlId]="control!.id.id" [controlVersion]="control!.id.version"
  [frequence]="control!.frequency" [isEditing]="selectedExecutionToEdit !== null"
  [executionToEdit]="selectedExecutionToEdit!" (close)="showPopup = false; selectedExecutionToEdit = null"
  (planifier)="handlePlanification($event)">
</app-planifier-execution-popup>

<app-popup-evaluation-controle *ngIf="showEvaluationPopup" [executionId]="selectedExecutionId!"
  (close)="showEvaluationPopup = false" (submitted)="handleEvaluationSubmitted()">
</app-popup-evaluation-controle>
}