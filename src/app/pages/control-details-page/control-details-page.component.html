@if(!control) {
<div class="spinner-container">
  <mat-spinner></mat-spinner>
  <p>Chargement des détails du contrôle...</p>
</div>
}
@else {
<div class="body-container">
  <app-go-back [title]="'Détails du contrôle'" [subtitle]="control.reference" [buttons]="goBackButtons"></app-go-back>

  <div class="details-grid">

    <div class="left-column">

      <mat-card class="general-info-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>info</mat-icon> Informations générales
          </mat-card-title>
        </mat-card-header>

        <mat-card-content class="info-content">
          <div class="info-grid">

            <div class="info-block">
              <mat-icon>label</mat-icon>
              <div class="info-text">
                <label>Nom du contrôle</label>
                <div class="value">{{ control.libelle || '—' }}</div>
              </div>
            </div>

            <div class="info-block">
              <mat-icon>settings</mat-icon>
              <div class="info-text">
                <label>Processus</label>
                <div class="value">{{ control.processName || '—' }}</div>
              </div>
            </div>

            <div class="info-block">
              <mat-icon>warning</mat-icon>
              <div class="info-text">
                <label>Risque couvert</label>
                <div class="value">{{ control.riskName || '—' }}</div>
              </div>
            </div>

            <div class="info-block">
              <mat-icon>person</mat-icon>
              <div class="info-text">
                <label>Responsable</label>
                <div class="value">{{ control.responsable || control.creator || '—' }}</div>
              </div>
            </div>

            <div class="info-block">
              <mat-icon>update</mat-icon>
              <div class="info-text">
                <label>Périodicité</label>
                <span class="badge freq">{{ control.frequency | enumLabel: 'recurrence' }}</span>
              </div>
            </div>

            <div class="info-block">
              <mat-icon>event</mat-icon>
              <div class="info-text">
                <label>Prochaine date</label>
                <div class="value">
                  {{ currentOrLatestExecution?.plannedAt ? (currentOrLatestExecution?.plannedAt | date:'dd/MM/yyyy') :
                  '—' }}
                </div>
              </div>
            </div>

            <div class="info-block full-width">
              <mat-icon>description</mat-icon>
              <div class="info-text">
                <label>Objectif</label>
                <div class="value description">{{ control.description || '—' }}</div>
              </div>
            </div>

          </div>
        </mat-card-content>
      </mat-card>

      <div class="methodology-wrapper">
        <app-methodology-card *ngIf="control" [controlId]="control.id"></app-methodology-card>
      </div>

    </div>

    <div class="right-column">
      <mat-card class="executions-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>history</mat-icon> Dernières exécutions
          </mat-card-title>
        </mat-card-header>

        <mat-card-content class="scrollable-content">
          @if(slides.length > 0) {
          <div class="execution-list">
            @for(s of slides; track s.exec.id) {
            <div class="execution-item compact">

              <div class="item-header">
                <div class="date-info">
                  <mat-icon>event</mat-icon>
                  <span>{{ s.exec.plannedAt | date:'dd/MM/yyyy' }}</span>
                </div>
                <span class="badge" [ngClass]="getStatusClass(s.exec.status)">
                  {{ s.exec.status | enumLabel:'status' }}
                </span>
              </div>

              <div class="item-body">
                <div class="meta-info">
                  <span class="label">Responsable :</span>
                  <span class="value">{{ s.exec.evaluator || '—' }}</span>
                </div>
                <div class="meta-info" *ngIf="s.view?.evaluatedAt">
                  <span class="label">Fait le :</span>
                  <span class="value">{{ s.view?.evaluatedAt | date:'dd/MM/yyyy' }}</span>
                </div>
              </div>

              <div class="item-actions">
                <button mat-flat-button color="primary" class="action-btn" (click)="openProcessDialog(s.exec)">
                  <mat-icon>visibility</mat-icon> Voir le détail
                </button>
              </div>

            </div>
            }
          </div>
          } @else {
          <div class="empty-state">
            <mat-icon>event_busy</mat-icon>
            <p>Aucune exécution</p>
          </div>
          }
        </mat-card-content>

        @if(allSlides.length > slides.length) {
        <mat-card-actions align="end" class="card-footer-actions">
          <button mat-button color="primary" (click)="viewFullHistory()">
            Voir tout l'historique ({{ allSlides.length }})
          </button>
        </mat-card-actions>
        }
      </mat-card>
    </div>
  </div>
</div>
}